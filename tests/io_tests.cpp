#include <catch2/catch_approx.hpp>
#include <catch2/catch_test_macros.hpp>
#include <fmt/ostream.h>
#include <iostream>
#include <occ/core/linear_algebra.h>
#include <occ/core/util.h>
#include <occ/crystal/crystal.h>
#include <occ/io/core_json.h>
#include <occ/io/crystalgrower.h>
#include <occ/io/dftb_gen.h>
#include <occ/io/eigen_json.h>
#include <occ/io/fchkreader.h>
#include <occ/io/fchkwriter.h>
#include <occ/io/gaussian_input_file.h>
#include <occ/io/gmf.h>
#include <occ/io/moldenreader.h>
#include <occ/io/orca_json.h>
#include <occ/io/qcschema.h>
#include <occ/io/wavefunction_json.h>
#include <occ/qm/hf.h>
#include <occ/qm/scf.h>
#include <sstream>

using occ::qm::HartreeFock;
using occ::util::all_close;
// CrystalGrower

auto acetic_crystal() {
    const std::vector<std::string> labels = {"C1", "C2", "H1", "H2",
                                             "H3", "H4", "O1", "O2"};
    occ::IVec nums(labels.size());
    occ::Mat positions(labels.size(), 3);
    for (size_t i = 0; i < labels.size(); i++) {
        nums(i) = occ::core::Element(labels[i]).atomic_number();
    }
    positions << 0.16510, 0.28580, 0.17090, 0.08940, 0.37620, 0.34810, 0.18200,
        0.05100, -0.11600, 0.12800, 0.51000, 0.49100, 0.03300, 0.54000, 0.27900,
        0.05300, 0.16800, 0.42100, 0.12870, 0.10750, 0.00000, 0.25290, 0.37030,
        0.17690;

    occ::crystal::AsymmetricUnit asym(positions.transpose(), nums, labels);
    occ::crystal::SpaceGroup sg(33);
    occ::crystal::UnitCell cell =
        occ::crystal::orthorhombic_cell(13.31, 4.1, 5.75);

    return occ::crystal::Crystal(asym, sg, cell);
}

TEST_CASE("Write acetic CrystalGrower structure file", "[write]") {
    auto acetic = acetic_crystal();
    auto dimers = acetic.unit_cell_dimers(3.8);
    occ::io::crystalgrower::StructureWriter writer(std::cout);
    occ::io::crystalgrower::NetWriter net_writer(std::cout);
    writer.write(acetic, dimers);
    net_writer.write(acetic, dimers);
    REQUIRE(true);
}

// Eigen JSON
using nlohmann::json;

namespace test {
struct test_struct {
    occ::Vec vector;
    occ::Mat3 matrix3d;
    occ::RowVec3 rvec3;

    bool operator==(const test_struct &other) const {
        using occ::util::all_close;
        return all_close(vector, other.vector) &&
               all_close(matrix3d, other.matrix3d) &&
               all_close(rvec3, other.rvec3);
    }
};

void to_json(json &js, const test_struct &t) {
    js = {{"vector", t.vector}, {"matrix3d", t.matrix3d}, {"rvec3", t.rvec3}};
}

void from_json(const json &j, test_struct &t) {
    j.at("vector").get_to(t.vector);
    j.at("matrix3d").get_to(t.matrix3d);
    j.at("rvec3").get_to(t.rvec3);
}

} // namespace test

TEST_CASE("eigen serialize/deserialize as part of struct",
          "[serialize,deserialize]") {
    auto t = test::test_struct{occ::Vec::Zero(10), occ::Mat3::Identity(),
                               occ::RowVec3::Zero()};
    nlohmann::json j = t;
    auto t2 = j.get<test::test_struct>();
    REQUIRE(t == t2);
}

// Fchk

using occ::Mat;

const char *fchk_contents = R"(h2
SP        RB3LYP                                                      STO-3G
Number of atoms                            I                2
Info1-9                                    I   N=           9
           9           9           0           0           0         110
           1          18        -502
Charge                                     I                0
Multiplicity                               I                1
Number of electrons                        I                2
Number of alpha electrons                  I                1
Number of beta electrons                   I                1
Number of basis functions                  I                2
Number of independent functions            I                2
Number of point charges in /Mol/           I                0
Number of translation vectors              I                0
Atomic numbers                             I   N=           2
           1           1
Nuclear charges                            R   N=           2
  1.00000000E+00  1.00000000E+00
Current cartesian coordinates              R   N=           6
  0.00000000E+00  0.00000000E+00  6.99198669E-01  8.56271412E-17  0.00000000E+00
 -6.99198669E-01
Force Field                                I                0
Int Atom Types                             I   N=           2
           0           0
MM charges                                 R   N=           2
  0.00000000E+00  0.00000000E+00
Integer atomic weights                     I   N=           2
           1           1
Real atomic weights                        R   N=           2
  1.00782504E+00  1.00782504E+00
Atom fragment info                         I   N=           2
           0           0
Atom residue num                           I   N=           2
           0           0
Nuclear spins                              I   N=           2
           1           1
Nuclear ZEff                               R   N=           2
 -1.00000000E+00 -1.00000000E+00
Nuclear ZNuc                               R   N=           2
  1.00000000E+00  1.00000000E+00
Nuclear QMom                               R   N=           2
  0.00000000E+00  0.00000000E+00
Nuclear GFac                               R   N=           2
  2.79284600E+00  2.79284600E+00
MicOpt                                     I   N=           2
          -1          -1
Number of contracted shells                I                2
Number of primitive shells                 I                6
Pure/Cartesian d shells                    I                0
Pure/Cartesian f shells                    I                0
Highest angular momentum                   I                0
Largest degree of contraction              I                3
Shell types                                I   N=           2
           0           0
Number of primitives per shell             I   N=           2
           3           3
Shell to atom map                          I   N=           2
           1           2
Primitive exponents                        R   N=           6
  3.42525091E+00  6.23913730E-01  1.68855404E-01  3.42525091E+00  6.23913730E-01
  1.68855404E-01
Contraction coefficients                   R   N=           6
  1.54328967E-01  5.35328142E-01  4.44634542E-01  1.54328967E-01  5.35328142E-01
  4.44634542E-01
Coordinates of each shell                  R   N=           6
  0.00000000E+00  0.00000000E+00  6.99198669E-01  8.56271412E-17  0.00000000E+00
 -6.99198669E-01
Constraint Structure                       R   N=           6
  0.00000000E+00  0.00000000E+00  6.99198669E-01  8.56271412E-17  0.00000000E+00
 -6.99198669E-01
Num ILSW                                   I              100
ILSW                                       I   N=         100
           0           0           0           0           2           0
           0           0           0           0         402          -1
           0           0           0           0           0           0
           0           0           0           0           0           0
           1           0           0           0           0           0
           0           0      100000           0          -1           0
           0           0           0           0           0           0
           0           0           0           1           0           0
           0           0           1           0           0           0
           0           0           4          41           0           0
           0           0           5           0           0           0
           0           0           0           2           0           0
           0           0           0           0           0           0
           0           0           0           0           0           0
           0           0           0           0           0           0
           0           0           0           0           0           0
           0           0           0           0
Num RLSW                                   I               41
RLSW                                       R   N=          41
  8.00000000E-01  7.20000000E-01  1.00000000E+00  8.10000000E-01  2.00000000E-01
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  1.00000000E+00  1.00000000E+00
  0.00000000E+00
MxBond                                     I                1
NBond                                      I   N=           2
           1           1
IBond                                      I   N=           2
           2           1
RBond                                      R   N=           2
  1.00000000E+00  1.00000000E+00
Virial Ratio                               R      1.970141361625062E+00
SCF Energy                                 R     -1.165418375762579E+00
Total Energy                               R     -1.165418375762579E+00
External E-field                           R   N=          35
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
IOpCl                                      I                0
IROHF                                      I                0
Alpha Orbital Energies                     R   N=           2
 -4.14539570E-01  4.27590260E-01
Alpha MO coefficients                      R   N=           4
  5.48842275E-01  5.48842275E-01  1.21245192E+00 -1.21245192E+00
Total SCF Density                          R   N=           3
  6.02455687E-01  6.02455687E-01  6.02455687E-01
Mulliken Charges                           R   N=           2
 -2.77555756E-16 -3.33066907E-16
ONIOM Charges                              I   N=          16
           0           0           0           0           0           0
           0           0           0           0           0           0
           0           0           0           0
ONIOM Multiplicities                       I   N=          16
           1           0           0           0           0           0
           0           0           0           0           0           0
           0           0           0           0
Atom Layers                                I   N=           2
           1           1
Atom Modifiers                             I   N=           2
           0           0
Force Field                                I                0
Int Atom Modified Types                    I   N=           2
           0           0
Link Atoms                                 I   N=           2
           0           0
Atom Modified MM Charges                   R   N=           2
  0.00000000E+00  0.00000000E+00
Link Distances                             R   N=           8
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00
Cartesian Gradient                         R   N=           6
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00
Dipole Moment                              R   N=           3
 -1.23259516E-32  0.00000000E+00  5.55111512E-17
Quadrupole Moment                          R   N=           6
 -1.04128604E-01 -1.04128604E-01  2.08257207E-01  0.00000000E+00 -1.91281142E-17
  0.00000000E+00
QEq coupling tensors                       R   N=          12
  1.83153654E-01  0.00000000E+00  1.83153654E-01  4.89879653E-17  0.00000000E+00
 -3.66307308E-01  1.83153654E-01  0.00000000E+00  1.83153654E-01  1.34443277E-17
  0.00000000E+00 -3.66307308E-01
)";

const char *unrestricted_fchk_contents =
    R"(water                                                                   
SP        UHF                                                         3-21G               
Number of atoms                            I                3
Info1-9                                    I   N=           9
          10          10           0           0           0         111
           1           1           2
Charge                                     I                0
Multiplicity                               I                1
Number of electrons                        I               10
Number of alpha electrons                  I                5
Number of beta electrons                   I                5
Number of basis functions                  I               13
Number of independent functions            I               13
Number of point charges in /Mol/           I                0
Number of translation vectors              I                0
Atomic numbers                             I   N=           3
           8           1           1
Nuclear charges                            R   N=           3
  8.00000000E+00  1.00000000E+00  1.00000000E+00
Current cartesian coordinates              R   N=           9
 -1.32695832E+00 -1.05938614E-01  1.87882241E-02 -1.93166520E+00  1.60017436E+00
 -2.17104966E-02  4.86644352E-01  7.95980993E-02  9.86248069E-03
Force Field                                I                0
Int Atom Types                             I   N=           3
           0           0           0
MM charges                                 R   N=           3
  0.00000000E+00  0.00000000E+00  0.00000000E+00
Integer atomic weights                     I   N=           3
          16           1           1
Real atomic weights                        R   N=           3
  1.59949146E+01  1.00782504E+00  1.00782504E+00
Atom fragment info                         I   N=           3
           0           0           0
Atom residue num                           I   N=           3
           0           0           0
Nuclear spins                              I   N=           3
           0           1           1
Nuclear ZEff                               R   N=           3
 -5.60000000E+00 -1.00000000E+00 -1.00000000E+00
Nuclear ZNuc                               R   N=           3
  8.00000000E+00  1.00000000E+00  1.00000000E+00
Nuclear QMom                               R   N=           3
  0.00000000E+00  0.00000000E+00  0.00000000E+00
Nuclear GFac                               R   N=           3
  0.00000000E+00  2.79284600E+00  2.79284600E+00
MicOpt                                     I   N=           3
          -1          -1          -1
Number of contracted shells                I                7
Number of primitive shells                 I               12
Pure/Cartesian d shells                    I                1
Pure/Cartesian f shells                    I                1
Highest angular momentum                   I                1
Largest degree of contraction              I                3
Shell types                                I   N=           7
           0          -1          -1           0           0           0
           0
Number of primitives per shell             I   N=           7
           3           2           1           2           1           2
           1
Shell to atom map                          I   N=           7
           1           1           1           2           2           3
           3
Primitive exponents                        R   N=          12
  3.22037000E+02  4.84308000E+01  1.04206000E+01  7.40294000E+00  1.57620000E+00
  3.73684000E-01  5.44717800E+00  8.24547240E-01  1.83191580E-01  5.44717800E+00
  8.24547240E-01  1.83191580E-01
Contraction coefficients                   R   N=          12
  5.92393934E-02  3.51499961E-01  7.07657921E-01 -4.04453583E-01  1.22156176E+00
  1.00000000E+00  1.56284979E-01  9.04690877E-01  1.00000000E+00  1.56284979E-01
  9.04690877E-01  1.00000000E+00
P(S=P) Contraction coefficients            R   N=          12
  0.00000000E+00  0.00000000E+00  0.00000000E+00  2.44586107E-01  8.53955373E-01
  1.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00
Coordinates of each shell                  R   N=          21
 -1.32695832E+00 -1.05938614E-01  1.87882241E-02 -1.32695832E+00 -1.05938614E-01
  1.87882241E-02 -1.32695832E+00 -1.05938614E-01  1.87882241E-02 -1.93166520E+00
  1.60017436E+00 -2.17104966E-02 -1.93166520E+00  1.60017436E+00 -2.17104966E-02
  4.86644352E-01  7.95980993E-02  9.86248069E-03  4.86644352E-01  7.95980993E-02
  9.86248069E-03
Constraint Structure                       R   N=           9
 -1.32695832E+00 -1.05938614E-01  1.87882241E-02 -1.93166520E+00  1.60017436E+00
 -2.17104966E-02  4.86644352E-01  7.95980993E-02  9.86248069E-03
Num ILSW                                   I              100
ILSW                                       I   N=         100
           1           1           0           0           2           0
           0           0           0           0           0          -1
           0           0           0           1           0           0
           0           0           0           0           0           0
           1           1           0           0           0           0
           0           0      100000           0          -1           0
           0           0           0           0           0           0
           0           0           0           1           0           0
           0           0           1           0           0           0
           0           0           4          41           0           0
           0           0           0           0           0           0
           0           0           0           3           0           0
           0           0           0           0           0           0
           0           0           0           0           0           0
           0           0           0           0           0           0
           0           0           0           0           0           0
           0           0           0           0
Num RLSW                                   I               41
RLSW                                       R   N=          41
  1.00000000E+00  1.00000000E+00  1.00000000E+00  1.00000000E+00  1.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  1.00000000E+00  1.00000000E+00
  0.00000000E+00
MxBond                                     I                2
NBond                                      I   N=           3
           2           1           1
IBond                                      I   N=           6
           2           3           1           0           1           0
RBond                                      R   N=           6
  1.00000000E+00  1.00000000E+00  1.00000000E+00  0.00000000E+00  1.00000000E+00
  0.00000000E+00
Virial Ratio                               R      2.001756519781691E+00
SCF Energy                                 R     -7.558532570429206E+01
Total Energy                               R     -7.558532570429206E+01
S**2                                       R      1.776356839400251E-15
S**2 after annihilation                    R      1.776356839400254E-15
RMS Density                                R      6.067827583034116E-10
External E-field                           R   N=          35
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
IOpCl                                      I                1
IROHF                                      I                0
Alpha Orbital Energies                     R   N=          13
 -2.04297795E+01 -1.32839993E+00 -6.82002142E-01 -5.38767334E-01 -4.79934816E-01
  2.62305860E-01  3.60309756E-01  1.18677618E+00  1.30827371E+00  1.78180383E+00
  1.86966403E+00  2.01413260E+00  3.11256620E+00
Beta Orbital Energies                      R   N=          13
 -2.04297795E+01 -1.32839993E+00 -6.82002142E-01 -5.38767334E-01 -4.79934816E-01
  2.62305860E-01  3.60309756E-01  1.18677618E+00  1.30827371E+00  1.78180383E+00
  1.86966403E+00  2.01413260E+00  3.11256620E+00
Alpha MO coefficients                      R   N=         169
  9.83233899E-01  9.58463391E-02  1.88750561E-03  3.00933014E-03 -7.85410800E-05
 -3.79135836E-02 -3.60972070E-03 -5.80733695E-03  1.51488012E-04  2.64516541E-03
  6.92318514E-03  2.65456006E-03  6.77097739E-03 -2.29162541E-01  2.17530408E-01
  4.34495281E-02  7.10960067E-02 -1.85279789E-03  7.06943412E-01  4.96654402E-02
  7.96881116E-02 -2.07903405E-03  1.17642634E-01  1.91844250E-02  1.15170013E-01
  1.96549799E-02 -1.03330237E-03  6.50462051E-04  3.35133926E-01 -2.15147968E-01
  4.48422079E-03  5.28170684E-03  3.12568729E-01 -1.99937826E-01  4.16449079E-03
 -2.34011521E-01 -1.84826668E-01  2.31814194E-01  1.86019113E-01  8.88460340E-02
 -8.27120954E-02  2.36980023E-01  3.71444444E-01 -9.70403126E-03 -4.06632282E-01
  2.72194642E-01  4.26240996E-01 -1.11362105E-02  1.30905470E-01  1.04911418E-01
  1.32780319E-01  1.08714416E-01  1.91546403E-11 -1.85557282E-11  1.25443751E-03
  1.28212655E-02  5.21398206E-01 -1.07867861E-10  1.51972490E-03  1.55326959E-02
  6.31663058E-01  4.84526262E-11  9.79552608E-11  8.15404582E-12  8.28760953E-12
 -1.08664463E-01  3.47985480E-02  1.16792672E-01  1.76291173E-01 -4.61602090E-03
  1.03754856E+00  2.59167046E-01  3.92334765E-01 -1.02711075E-02 -4.52521119E-02
 -8.50558615E-01 -4.75660670E-02 -8.69242587E-01  1.44542424E-03 -2.46324510E-04
  2.56249463E-01 -1.63954999E-01  3.41516638E-03 -1.79988379E-02  6.50715573E-01
 -4.16934234E-01  8.68691612E-03  3.77102984E-02  1.18473780E+00 -3.90730672E-02
 -1.15927293E+00  1.10762081E-03 -3.19393067E-03 -1.56206450E-01  9.03240763E-02
 -1.84526476E-03  6.30106009E-03 -3.70943321E-01  2.33868057E-01 -4.85839652E-03
 -9.39608766E-01  6.78315510E-01  9.83895693E-01 -7.10060657E-01  6.78879214E-02
 -1.00569472E-01 -1.48263505E-01 -2.40661619E-01  6.27461653E-03 -1.05562969E-01
 -1.39653782E-01 -2.59919005E-01  6.72744450E-03  1.00802184E+00 -5.00044119E-01
  9.56903028E-01 -4.77467310E-01 -4.07068076E-12  1.32658754E-11  2.47525860E-03
  2.52989473E-02  1.02882401E+00  8.40823396E-12 -2.32184300E-03 -2.37309279E-02
 -9.65057881E-01 -3.14446272E-11 -1.41539884E-11 -1.42218098E-11  9.87599497E-12
 -4.59528509E-02  1.40740541E-01 -5.32367082E-01 -8.56097566E-01  2.23324039E-02
  1.67317191E-01  6.07848474E-01  9.82911294E-01 -2.56323753E-02 -2.67432634E-01
 -9.50620250E-02 -2.67866205E-01 -8.19727255E-02 -2.98416367E-04  1.95681730E-03
 -9.05323672E-01  5.63977138E-01 -1.16901604E-02 -3.56406478E-03  1.17875809E+00
 -7.35538072E-01  1.52510125E-02  1.31416982E-01  5.05564351E-01 -1.40812835E-01
 -5.00427404E-01  8.46144580E-02 -1.63995218E+00 -8.77708985E-02 -1.38414354E-01
  3.61480009E-03  1.98805284E+00  2.66036438E-01  4.27676880E-01 -1.11567029E-02
 -2.91124366E-01 -3.60494228E-01 -2.90744521E-01 -3.50869080E-01
Beta MO coefficients                       R   N=         169
  9.83233899E-01  9.58463391E-02  1.88750561E-03  3.00933014E-03 -7.85410800E-05
 -3.79135836E-02 -3.60972070E-03 -5.80733695E-03  1.51488012E-04  2.64516541E-03
  6.92318514E-03  2.65456006E-03  6.77097739E-03 -2.29162541E-01  2.17530408E-01
  4.34495281E-02  7.10960067E-02 -1.85279789E-03  7.06943412E-01  4.96654402E-02
  7.96881116E-02 -2.07903405E-03  1.17642634E-01  1.91844250E-02  1.15170013E-01
  1.96549799E-02 -1.03330237E-03  6.50462051E-04  3.35133926E-01 -2.15147968E-01
  4.48422079E-03  5.28170684E-03  3.12568729E-01 -1.99937826E-01  4.16449079E-03
 -2.34011521E-01 -1.84826668E-01  2.31814194E-01  1.86019113E-01  8.88460340E-02
 -8.27120954E-02  2.36980023E-01  3.71444444E-01 -9.70403126E-03 -4.06632282E-01
  2.72194642E-01  4.26240996E-01 -1.11362105E-02  1.30905470E-01  1.04911418E-01
  1.32780319E-01  1.08714416E-01  1.91546403E-11 -1.85557282E-11  1.25443751E-03
  1.28212655E-02  5.21398206E-01 -1.07867861E-10  1.51972490E-03  1.55326959E-02
  6.31663058E-01  4.84526262E-11  9.79552608E-11  8.15404582E-12  8.28760953E-12
 -1.08664463E-01  3.47985480E-02  1.16792672E-01  1.76291173E-01 -4.61602090E-03
  1.03754856E+00  2.59167046E-01  3.92334765E-01 -1.02711075E-02 -4.52521119E-02
 -8.50558615E-01 -4.75660670E-02 -8.69242587E-01  1.44542424E-03 -2.46324510E-04
  2.56249463E-01 -1.63954999E-01  3.41516638E-03 -1.79988379E-02  6.50715573E-01
 -4.16934234E-01  8.68691612E-03  3.77102984E-02  1.18473780E+00 -3.90730672E-02
 -1.15927293E+00  1.10762081E-03 -3.19393067E-03 -1.56206450E-01  9.03240763E-02
 -1.84526476E-03  6.30106009E-03 -3.70943321E-01  2.33868057E-01 -4.85839652E-03
 -9.39608766E-01  6.78315510E-01  9.83895693E-01 -7.10060657E-01  6.78879214E-02
 -1.00569472E-01 -1.48263505E-01 -2.40661619E-01  6.27461653E-03 -1.05562969E-01
 -1.39653782E-01 -2.59919005E-01  6.72744450E-03  1.00802184E+00 -5.00044119E-01
  9.56903028E-01 -4.77467310E-01 -4.07068076E-12  1.32658754E-11  2.47525860E-03
  2.52989473E-02  1.02882401E+00  8.40823396E-12 -2.32184300E-03 -2.37309279E-02
 -9.65057881E-01 -3.14446272E-11 -1.41539884E-11 -1.42218098E-11  9.87599497E-12
 -4.59528509E-02  1.40740541E-01 -5.32367082E-01 -8.56097566E-01  2.23324039E-02
  1.67317191E-01  6.07848474E-01  9.82911294E-01 -2.56323753E-02 -2.67432634E-01
 -9.50620250E-02 -2.67866205E-01 -8.19727255E-02 -2.98416367E-04  1.95681730E-03
 -9.05323672E-01  5.63977138E-01 -1.16901604E-02 -3.56406478E-03  1.17875809E+00
 -7.35538072E-01  1.52510125E-02  1.31416982E-01  5.05564351E-01 -1.40812835E-01
 -5.00427404E-01  8.46144580E-02 -1.63995218E+00 -8.77708985E-02 -1.38414354E-01
  3.61480009E-03  1.98805284E+00  2.66036438E-01  4.27676880E-01 -1.11567029E-02
 -2.91124366E-01 -3.60494228E-01 -2.90744521E-01 -3.50869080E-01
Total SCF Density                          R   N=          91
  2.05431811E+00  7.40804699E-02  1.26695426E-01  2.52145914E-02 -1.95012366E-02
  3.40734555E-01  3.97800249E-02 -3.02178345E-02  3.80647621E-02  3.78975413E-01
 -1.03886124E-03  7.89979621E-04 -4.46874012E-04  3.96748491E-03  5.43947609E-01
 -4.70831985E-01  3.67569308E-01 -1.27897706E-01 -2.04061783E-01  5.32562235E-03
  1.33316827E+00  1.78595564E-02 -2.37054204E-02  3.42820222E-01  7.47925937E-02
 -1.07822560E-03 -1.47569438E-01  3.48542259E-01  2.82098351E-02 -3.72147250E-02
  7.49511734E-02  4.14376492E-01  5.83741724E-03 -2.35648399E-01  1.15057033E-01
  4.56563412E-01 -7.36652857E-04  9.72149167E-04 -1.08212510E-03  5.83779877E-03
  6.58957132E-01  6.14967073E-03 -1.74675226E-03  8.13105492E-03  7.98287844E-01
 -2.49724644E-02  2.97293964E-02 -8.45734171E-02  2.14686189E-01 -5.07569171E-03
  5.72000541E-02 -6.33593821E-02  2.23888782E-01 -5.35302399E-03  1.71488840E-01
  2.38454080E-02 -7.92181645E-03 -7.24663098E-02  1.60237232E-01 -3.76591167E-03
 -6.06734992E-02 -5.65737974E-02  1.66319910E-01 -3.95372166E-03  1.18520535E-01
  9.11665513E-02 -2.44502576E-02  2.89513152E-02  2.28328355E-01  1.52845507E-02
 -9.25187166E-04  5.70992966E-02  2.28620693E-01  3.88205088E-02 -1.50464349E-03
 -4.66191930E-02 -5.33748501E-02  1.69279225E-01  2.32398001E-02 -7.89293913E-03
  1.77942480E-01  3.55499647E-03 -5.15531634E-04 -5.91720920E-02  1.77373942E-01
  2.13464615E-02 -9.51658762E-04 -5.39382594E-02 -4.51039261E-02  1.19677287E-01
  9.37081976E-02
Spin SCF Density                           R   N=          91
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00
Mulliken Charges                           R   N=           3
 -7.24461767E-01  3.63043495E-01  3.61418272E-01
ONIOM Charges                              I   N=          16
           0           0           0           0           0           0
           0           0           0           0           0           0
           0           0           0           0
ONIOM Multiplicities                       I   N=          16
           1           0           0           0           0           0
           0           0           0           0           0           0
           0           0           0           0
Atom Layers                                I   N=           3
           1           1           1
Atom Modifiers                             I   N=           3
           0           0           0
Force Field                                I                0
Int Atom Modified Types                    I   N=           3
           0           0           0
Link Atoms                                 I   N=           3
           0           0           0
Atom Modified MM Charges                   R   N=           3
  0.00000000E+00  0.00000000E+00  0.00000000E+00
Link Distances                             R   N=          12
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00
Cartesian Gradient                         R   N=           9
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
Dipole Moment                              R   N=           3
  5.15346378E-01  8.13553371E-01 -2.12452852E-02
Quadrupole Moment                          R   N=           6
 -1.50772647E-01  6.97836931E-01 -5.47064284E-01 -1.48317294E+00  4.22126276E-02
 -1.64760439E-02
Anisotropic Hyperfine tensors              R   N=          18
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00
Isotropic Hyperfine splittings             R   N=           3
  0.00000000E+00  0.00000000E+00  0.00000000E+00
QEq coupling tensors                       R   N=          18
 -1.38887030E+00  7.04259404E-01 -6.92045268E-01 -8.96597254E-03  6.65328662E-02
  2.08091557E+00  1.48720977E-01  2.95841762E-01 -4.82586853E-01 -6.82824746E-03
  1.93762470E-02  3.33865876E-01 -5.74458624E-01 -5.38520401E-02  2.51944229E-01
  3.48239778E-03  1.86622939E-03  3.22514395E-01
)";

TEST_CASE("Read H2 fchk contents", "[read]") {
    std::istringstream fchk(fchk_contents);
    occ::io::FchkReader reader(fchk);
    REQUIRE(reader.num_alpha() == 1);
    REQUIRE(reader.num_basis_functions() == 2);
    fmt::print("Alpha MOs:\n{}\n", reader.alpha_mo_coefficients());
    fmt::print("Alpha MO energies:\n{}\n", reader.alpha_mo_energies());
    fmt::print("Positions:\n{}\n", reader.atomic_positions());
    REQUIRE(reader.basis().primitive_exponents[0] == Catch::Approx(3.42525091));

    occ::io::FchkReader::FchkBasis basis = reader.basis();
    basis.print();
    //    fmt::print("Libint2 basis:\n");
    //    for(const auto& shell: reader.basis_set())
    //    {
    //        fmt::print("\n{}\n", shell);
    //    }
    auto density = reader.scf_density_matrix();
    fmt::print("Density matrix\n{}\n", density);

    REQUIRE(density(1, 0) == Catch::Approx(0.301228));
}

TEST_CASE("Write H2 fchk contents", "[write]") {
    occ::io::FchkWriter writer(std::cout);
    writer.set_scalar("Charge", 0);
    writer.set_scalar("Multiplicity", 1);
    writer.set_scalar("Number of electrons", 10);
    writer.set_scalar("SCF Energy", -76.42165911602731);
    writer.set_scalar("Test string", std::string("this string"));
    Mat identity = Mat::Identity(3, 3);
    writer.set_vector("Identity matrix", identity);
    writer.write();
    REQUIRE(true);
}

TEST_CASE("Read water UHF fchk file", "[read]") {
    std::istringstream fchk(unrestricted_fchk_contents);
    occ::io::FchkReader reader(fchk);
    REQUIRE(reader.num_alpha() == 5);
    REQUIRE(reader.num_beta() == 5);
    REQUIRE(reader.num_basis_functions() == 13);
    fmt::print("Alpha MOs:\n{}\n", reader.alpha_mo_coefficients());
    fmt::print("Beta MOs:\n{}\n", reader.alpha_mo_coefficients());
    fmt::print("Alpha MO energies:\n{}\n", reader.alpha_mo_energies());
    fmt::print("Beta MO energies:\n{}\n", reader.alpha_mo_energies());
    fmt::print("Positions:\n{}\n", reader.atomic_positions());
    CHECK(reader.basis().primitive_exponents[0] ==
          Catch::Approx(3.22037000e02));

    occ::io::FchkReader::FchkBasis basis = reader.basis();
    basis.print();
    //    fmt::print("Libint2 basis:\n");
    //    for(const auto& shell: reader.basis_set())
    //    {
    //        fmt::print("\n{}\n", shell);
    //    }
    auto density = reader.scf_density_matrix();
    int nbf = 13;
    Mat density_expected(nbf, nbf);
    density_expected << 1.027159055811635913e+00, 3.704023489202387664e-02,
        1.260729573645737699e-02, 1.989001246282115845e-02,
        -5.194306171339705324e-04, -2.354159924174853424e-01,
        8.929778175037792615e-03, 1.410491755866299067e-02,
        -3.683264284039888077e-04, -1.248623214013617339e-02,
        1.192270398277695161e-02, -1.222512880781454966e-02,
        1.161990007192056397e-02, 3.704023489202387664e-02,
        6.334771294985715173e-02, -9.750618291678152944e-03,
        -1.510891725501560187e-02, 3.949898091787798038e-04,
        1.837846543064179383e-01, -1.185271014402013157e-02,
        -1.860736245068380507e-02, 4.860745829954922904e-04,
        1.486469825614799428e-02, -3.960908199636133109e-03,
        1.447565770463709982e-02, -3.946469581940933134e-03,
        1.260729573645737699e-02, -9.750618291678152944e-03,
        1.703672774402610057e-01, 1.903238124037974141e-02,
        -2.234370062451817760e-04, -6.394885284870387154e-02,
        1.714101107876532804e-01, 3.747558671183424950e-02,
        -5.410625524466284057e-04, -4.228670877418309881e-02,
        -3.623315486170241434e-02, 1.141641772014494183e-01,
        8.897124031412841083e-02, 1.989001246282115845e-02,
        -1.510891725501560187e-02, 1.903238124037974141e-02,
        1.894877061985975886e-01, 1.983742456148060874e-03,
        -1.020308913292919395e-01, 3.739629697712439083e-02,
        2.071882458996356091e-01, 2.918899383189254605e-03,
        1.073430944241324791e-01, 8.011861553997037810e-02,
        7.642275436028479405e-03, 1.777498323894319537e-03,
        -5.194306171339705324e-04, 3.949898091787798038e-04,
        -2.234370062451817760e-04, 1.983742456148060874e-03,
        2.719738047075293541e-01, 2.662811170929253561e-03,
        -5.391127968595087281e-04, 2.918708620554830071e-03,
        3.294785660005331573e-01, -2.537845853486923875e-03,
        -1.882955832520055890e-03, -4.625935829770838376e-04,
        -2.577658182671186912e-04, -2.354159924174853424e-01,
        1.837846543064179383e-01, -6.394885284870387154e-02,
        -1.020308913292919395e-01, 2.662811170929253561e-03,
        6.665841367832672226e-01, -7.378471882986549490e-02,
        -1.178241994049793046e-01, 3.074835361423340196e-03,
        2.860002713323228640e-02, -3.033674947761145699e-02,
        2.854964855994925055e-02, -2.958604610690653350e-02,
        8.929778175037792615e-03, -1.185271014402013157e-02,
        1.714101107876532804e-01, 3.739629697712439083e-02,
        -5.391127968595087281e-04, -7.378471882986549490e-02,
        1.742711290797470391e-01, 5.752851659054463579e-02,
        -8.733761301656478267e-04, -3.167969125219934762e-02,
        -2.828689868979465671e-02, 1.143103465506893623e-01,
        8.868697115510079665e-02, 1.410491755866299067e-02,
        -1.860736245068380507e-02, 3.747558671183424950e-02,
        2.071882458996356091e-01, 2.918708620554830071e-03,
        -1.178241994049793046e-01, 5.752851659054463579e-02,
        2.282817058714250447e-01, 4.065527461716612195e-03,
        1.119443906633796754e-01, 8.315995481986421245e-02,
        1.941025435977715430e-02, 1.067323079244111329e-02,
        -3.683264284039888077e-04, 4.860745829954922904e-04,
        -5.410625524466284057e-04, 2.918899383189254605e-03,
        3.294785660005331573e-01, 3.074835361423340196e-03,
        -8.733761301656478267e-04, 4.065527461716612195e-03,
        3.991439223409505299e-01, -2.676511993842408017e-03,
        -1.976860822710261884e-03, -7.523217461259853458e-04,
        -4.758293834331794002e-04, -1.248623214013617339e-02,
        1.486469825614799428e-02, -4.228670877418309881e-02,
        1.073430944241324791e-01, -2.537845853486923875e-03,
        2.860002713323228640e-02, -3.167969125219934762e-02,
        1.119443906633796754e-01, -2.676511993842408017e-03,
        8.574442027115855569e-02, 5.926026744033328908e-02,
        -2.330959662430042573e-02, -2.696912988410838166e-02,
        1.192270398277695161e-02, -3.960908199636133109e-03,
        -3.623315486170241434e-02, 8.011861553997037810e-02,
        -1.882955832520055890e-03, -3.033674947761145699e-02,
        -2.828689868979465671e-02, 8.315995481986421245e-02,
        -1.976860822710261884e-03, 5.926026744033328908e-02,
        4.558327548581628946e-02, -2.668742503593509591e-02,
        -2.255196308268581779e-02, -1.222512880781454966e-02,
        1.447565770463709982e-02, 1.141641772014494183e-01,
        7.642275436028479405e-03, -4.625935829770838376e-04,
        2.854964855994925055e-02, 1.143103465506893623e-01,
        1.941025435977715430e-02, -7.523217461259853458e-04,
        -2.330959662430042573e-02, -2.668742503593509591e-02,
        8.463961223714372428e-02, 5.983864384181302593e-02,
        1.161990007192056397e-02, -3.946469581940933134e-03,
        8.897124031412841083e-02, 1.777498323894319754e-03,
        -2.577658182671185827e-04, -2.958604610690653697e-02,
        8.868697115510079665e-02, 1.067323079244111676e-02,
        -4.758293834331793460e-04, -2.696912988410838166e-02,
        -2.255196308268581432e-02, 5.983864384181302593e-02,
        4.685409901721312304e-02;

    for (int i = 0; i < nbf; i++) {
        for (int j = 0; j < nbf; j++) {
            INFO("DENSITY(" << i << ", " << j << ")");
            CHECK(density(i, j) == Catch::Approx(density_expected(i, j)));
        }
    }
}

// Fchk Pure

const char *pure_fchk_contents =
    R"(water                                                                   
SP        RHF                                                         6-31G(d,p)          
Number of atoms                            I                3
Info1-9                                    I   N=           9
          10          10           0           0           0         111
           1           1           2
Charge                                     I                0
Multiplicity                               I                1
Number of electrons                        I               10
Number of alpha electrons                  I                5
Number of beta electrons                   I                5
Number of basis functions                  I               24
Number of independent functions            I               24
Number of point charges in /Mol/           I                0
Number of translation vectors              I                0
Atomic numbers                             I   N=           3
           8           1           1
Nuclear charges                            R   N=           3
  8.00000000E+00  1.00000000E+00  1.00000000E+00
Current cartesian coordinates              R   N=           9
 -1.32695832E+00 -1.05938614E-01  1.87882241E-02 -1.93166520E+00  1.60017436E+00
 -2.17104966E-02  4.86644352E-01  7.95980993E-02  9.86248069E-03
Force Field                                I                0
Int Atom Types                             I   N=           3
           0           0           0
MM charges                                 R   N=           3
  0.00000000E+00  0.00000000E+00  0.00000000E+00
Integer atomic weights                     I   N=           3
          16           1           1
Real atomic weights                        R   N=           3
  1.59949146E+01  1.00782504E+00  1.00782504E+00
Atom fragment info                         I   N=           3
           0           0           0
Atom residue num                           I   N=           3
           0           0           0
Nuclear spins                              I   N=           3
           0           1           1
Nuclear ZEff                               R   N=           3
 -5.60000000E+00 -1.00000000E+00 -1.00000000E+00
Nuclear ZNuc                               R   N=           3
  8.00000000E+00  1.00000000E+00  1.00000000E+00
Nuclear QMom                               R   N=           3
  0.00000000E+00  0.00000000E+00  0.00000000E+00
Nuclear GFac                               R   N=           3
  0.00000000E+00  2.79284600E+00  2.79284600E+00
MicOpt                                     I   N=           3
          -1          -1          -1
Number of contracted shells                I               10
Number of primitive shells                 I               21
Pure/Cartesian d shells                    I                0
Pure/Cartesian f shells                    I                0
Highest angular momentum                   I                2
Largest degree of contraction              I                6
Shell types                                I   N=          10
           0          -1          -1          -2           0           0
           1           0           0           1
Number of primitives per shell             I   N=          10
           6           3           1           1           3           1
           1           3           1           1
Shell to atom map                          I   N=          10
           1           1           1           1           2           2
           2           3           3           3
Primitive exponents                        R   N=          21
  5.48467166E+03  8.25234946E+02  1.88046958E+02  5.29645000E+01  1.68975704E+01
  5.79963534E+00  1.55396162E+01  3.59993359E+00  1.01376175E+00  2.70005823E-01
  8.00000000E-01  1.87311370E+01  2.82539436E+00  6.40121692E-01  1.61277759E-01
  1.10000000E+00  1.87311370E+01  2.82539436E+00  6.40121692E-01  1.61277759E-01
  1.10000000E+00
Contraction coefficients                   R   N=          21
  1.83107443E-03  1.39501722E-02  6.84450781E-02  2.32714336E-01  4.70192898E-01
  3.58520853E-01 -1.10777550E-01 -1.48026263E-01  1.13076702E+00  1.00000000E+00
  1.00000000E+00  3.34946043E-02  2.34726953E-01  8.13757326E-01  1.00000000E+00
  1.00000000E+00  3.34946043E-02  2.34726953E-01  8.13757326E-01  1.00000000E+00
  1.00000000E+00
P(S=P) Contraction coefficients            R   N=          21
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  7.08742682E-02  3.39752839E-01  7.27158577E-01  1.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00
Coordinates of each shell                  R   N=          30
 -1.32695832E+00 -1.05938614E-01  1.87882241E-02 -1.32695832E+00 -1.05938614E-01
  1.87882241E-02 -1.32695832E+00 -1.05938614E-01  1.87882241E-02 -1.32695832E+00
 -1.05938614E-01  1.87882241E-02 -1.93166520E+00  1.60017436E+00 -2.17104966E-02
 -1.93166520E+00  1.60017436E+00 -2.17104966E-02 -1.93166520E+00  1.60017436E+00
 -2.17104966E-02  4.86644352E-01  7.95980993E-02  9.86248069E-03  4.86644352E-01
  7.95980993E-02  9.86248069E-03  4.86644352E-01  7.95980993E-02  9.86248069E-03
Constraint Structure                       R   N=           9
 -1.32695832E+00 -1.05938614E-01  1.87882241E-02 -1.93166520E+00  1.60017436E+00
 -2.17104966E-02  4.86644352E-01  7.95980993E-02  9.86248069E-03
Num ILSW                                   I              100
ILSW                                       I   N=         100
           0           0           0           0           2           0
           0           0           0           0           0          -1
           0           0           0           0           0           0
           0           0           0           0           0           0
           1           1           0           0           0           0
           0           0      100000           0          -1           0
           0           0           0           0           0           0
           0           0           0           1           0           0
           0           0           1           0           0           0
           0           0           4          41           0           0
           0           0           0           0           0           0
           0           0           0           3           0           0
           0           0           0           0           0           0
           0           0           0           0           0           0
           0           0           0           0           0           0
           0           0           0           0           0           0
           0           0           0           0
Num RLSW                                   I               41
RLSW                                       R   N=          41
  1.00000000E+00  1.00000000E+00  1.00000000E+00  1.00000000E+00  1.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  1.00000000E+00  1.00000000E+00
  0.00000000E+00
MxBond                                     I                2
NBond                                      I   N=           3
           2           1           1
IBond                                      I   N=           6
           2           3           1           0           1           0
RBond                                      R   N=           6
  1.00000000E+00  1.00000000E+00  1.00000000E+00  0.00000000E+00  1.00000000E+00
  0.00000000E+00
Virial Ratio                               R      2.001700508404843E+00
SCF Energy                                 R     -7.602228059102917E+01
Total Energy                               R     -7.602228059102917E+01
RMS Density                                R      3.113711538125358E-09
External E-field                           R   N=          35
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
IOpCl                                      I                0
IROHF                                      I                0
Alpha Orbital Energies                     R   N=          24
 -2.05589450E+01 -1.33844050E+00 -6.99083537E-01 -5.69456117E-01 -4.96636158E-01
  2.14584623E-01  3.03887789E-01  9.99392947E-01  1.08838247E+00  1.16924736E+00
  1.19339506E+00  1.29513767E+00  1.59997737E+00  1.80542135E+00  1.82444270E+00
  1.92259977E+00  2.57752454E+00  2.58758038E+00  2.79825308E+00  2.96948666E+00
  2.99238082E+00  3.36881195E+00  3.73369557E+00  3.92411724E+00
Alpha MO coefficients                      R   N=         576
  9.95714758E-01  2.19148286E-02  1.11882321E-03  1.81673565E-03 -4.73656095E-05
 -5.92622076E-03 -5.41139116E-04 -8.30914590E-04  2.17342553E-05 -3.61628552E-04
  2.66602223E-06 -1.36187347E-05  5.57186920E-05 -1.75185134E-04 -5.18830333E-04
  1.25992249E-03 -3.35148445E-04  1.12586985E-03 -2.68789830E-05 -4.59678195E-04
  1.24904471E-03  1.12419360E-03  1.75409608E-04 -7.01805969E-06 -2.12025356E-01
  4.70848647E-01  4.35442905E-02  7.12459986E-02 -1.85671419E-03  4.40694871E-01
  1.82535625E-02  2.90395744E-02 -7.58004229E-04 -3.75515177E-03 -4.63414823E-05
 -1.79142300E-04 -6.48205845E-04  1.31116774E-03  1.45563375E-01  1.06542201E-02
  1.09764134E-02 -2.38455420E-02  5.59957431E-04  1.42840399E-01  1.07671479E-02
 -2.59618526E-02 -2.25681233E-04  6.80114345E-05 -8.81323533E-04  2.01301980E-03
  4.21752124E-01 -2.71031847E-01  5.65001864E-03  4.42234092E-03  2.34917268E-01
 -1.50622895E-01  3.13865117E-03  6.12837893E-05 -4.29461251E-04  7.24045834E-04
  3.07373123E-02  1.44694361E-02 -2.40688447E-01 -1.33825941E-01  8.15652506E-04
  2.17754461E-02 -5.37424097E-04  2.38736776E-01  1.34282685E-01 -1.92761866E-02
 -1.00882557E-02  2.94448607E-04  7.10298020E-02 -1.69017710E-01  2.97075873E-01
  4.64626515E-01 -1.21399784E-02 -3.07754879E-01  2.10638240E-01  3.29409551E-01
 -8.60701040E-03 -1.81603937E-02 -5.47897461E-04 -1.05366995E-03 -9.39869761E-03
  2.01205327E-02  1.45304715E-01  8.60384496E-02  1.62293355E-02 -4.64182919E-03
  7.50969944E-05  1.47895469E-01  8.91182209E-02 -1.14399755E-02  1.24818558E-02
 -2.79407275E-04 -5.89909141E-12  1.54916883E-11  1.53618758E-03  1.57009570E-02
  6.38505678E-01  3.76225569E-11  1.20410776E-03  1.23068591E-02  5.00479011E-01
 -1.06047130E-03  1.47160707E-02  2.34436892E-02 -5.41445201E-04  4.18346403E-04
 -1.45126752E-11 -2.60336607E-11  4.90245884E-05  5.01067038E-04  2.03767292E-02
 -1.24905162E-11 -2.15167016E-11  4.85891718E-05  4.96616751E-04  2.01957509E-02
 -8.64938453E-02  9.68177246E-02  1.21481796E-01  1.83811870E-01 -4.81223769E-03
  1.21944142E+00  2.76004516E-01  4.21992481E-01 -1.10409050E-02 -2.05499028E-02
 -1.91509637E-04 -9.40439736E-04 -2.18553740E-03  4.51710664E-03 -5.75570902E-02
 -1.00050915E+00 -4.85917978E-03  1.21753210E-02 -2.87702344E-04 -5.95549280E-02
 -1.01774266E+00  1.29835241E-02  6.26918500E-04 -4.66532252E-05  9.49669541E-04
 -6.55511585E-04  2.79495456E-01 -1.78141966E-01  3.70809842E-03 -2.08810277E-02
  7.17503789E-01 -4.59940584E-01  9.58376271E-03  5.19489641E-04 -4.67980996E-04
  7.93966718E-04  3.29254300E-02  1.58996285E-02  5.55739960E-02  1.42186112E+00
  8.12821629E-03 -1.51701438E-02  3.53480507E-04 -5.58937546E-02 -1.39404301E+00
  1.62663875E-02 -7.73407700E-04 -2.01172549E-05  8.71029572E-04 -9.87400355E-03
 -1.31628367E-01  6.69588396E-02 -1.32984251E-03  2.29348398E-02 -2.85668147E-01
  1.94987482E-01 -4.10748142E-03 -5.76816173E-03 -3.42499598E-03  5.56248868E-03
  2.47236495E-01  1.14128556E-01 -7.51420071E-01  6.12709083E-01 -1.37941311E-02
 -1.12203426E-01  2.79228768E-03  7.90780153E-01 -6.56481966E-01  1.04118410E-01
  5.85352927E-02 -1.68989182E-03  3.65253268E-02 -2.96609601E-01 -2.75783158E-01
 -4.34702267E-01  1.13529080E-02  5.95441406E-01  2.09972418E-01  2.91593103E-01
 -7.67549598E-03 -2.24140838E-01  1.72012520E-03 -8.22876061E-03  4.28130099E-02
 -1.12143919E-01  6.61483586E-01 -6.37351371E-01 -1.23696666E-01  1.62734820E-01
 -3.70407218E-03  6.19791405E-01 -6.17475842E-01  1.93687706E-01 -4.57059918E-02
  6.57922356E-04 -5.80641574E-12  3.54110795E-11 -2.31559143E-03 -2.36670323E-02
 -9.62459454E-01 -1.23694180E-11  2.50283857E-03  2.55808344E-02  1.04028742E+00
 -5.50106829E-04  7.83266823E-03  1.21416755E-02 -2.79911260E-04  2.21855942E-04
 -5.09888825E-11  1.32532164E-11 -2.32016179E-05 -2.37137506E-04 -9.64359325E-03
 -4.79410984E-11  1.88300250E-11 -1.74007843E-05 -1.77848648E-04 -7.23251294E-03
 -6.28131917E-02  4.02804770E-01 -3.98277834E-01 -6.45006934E-01  1.68190448E-02
 -8.66711741E-03  6.05158340E-01  9.95994390E-01 -2.59476187E-02  6.48449709E-02
 -1.21849430E-03  1.81264526E-03 -3.24081834E-02  6.37159330E-02 -4.23546219E-01
 -1.08673349E-02  2.05302820E-02  4.49767587E-02 -1.15537973E-03 -4.18963258E-01
  1.30694774E-02  2.80129894E-02  3.92029994E-02 -1.03140479E-03 -8.16639848E-04
  6.57709258E-03 -7.48556221E-01  4.64812491E-01 -9.62885429E-03 -1.53619940E-02
  1.49366749E+00 -9.34926151E-01  1.93963535E-02  3.79166872E-03 -1.90974878E-03
  3.26300875E-03  1.32447004E-01  6.53544176E-02  1.19292793E-01  9.63165888E-01
  7.84125494E-02 -2.02435137E-01  4.78925887E-03 -1.29417702E-01 -9.49664488E-01
  2.13471734E-01  1.61148367E-02 -9.09860330E-04  5.08700069E-02 -1.45097260E+00
 -5.41668070E-02 -8.03340454E-02  2.10574755E-03  2.45902049E+00  3.03463239E-01
  4.84930614E-01 -1.26546270E-02  8.22486044E-02 -4.52463211E-03  5.23335712E-04
 -1.00846506E-01  2.07807007E-01 -2.55473153E-01 -6.17864789E-01  1.01041493E-01
  1.76774688E-01 -4.59001472E-03 -2.53744040E-01 -6.06011312E-01  1.15176187E-01
  1.67680715E-01 -4.40039927E-03 -3.82244236E-15 -1.05428484E-12  6.02486031E-06
  6.15784615E-05  2.50419115E-03  2.24847590E-12 -5.35979870E-06 -5.47810528E-05
 -2.22776320E-03  1.28228197E-02  5.70910466E-01 -3.56740194E-01  1.01502918E-02
  1.31796189E-02 -1.45515865E-12 -1.10787639E-12 -8.48736475E-04 -8.67470545E-03
 -3.52771407E-01 -8.52403593E-14  1.91723128E-13  8.58824970E-04  8.77781724E-03
  3.56964620E-01  7.45436780E-03 -5.43121596E-01 -1.67816266E-02 -2.52737459E-02
  6.61860558E-04  1.03268988E+00  2.89904321E-01  4.62823771E-01 -1.20783946E-02
  3.67183568E-01  1.34999788E-02  2.28148159E-02  2.41298139E-01 -5.10325268E-01
 -2.76618496E-01 -2.15022314E-01 -2.85806768E-01 -7.14222040E-02  2.44390898E-03
 -2.74691791E-01 -2.09411629E-01  5.72953965E-02 -2.90500646E-01  7.00560984E-03
  2.30623450E-13 -5.00255008E-12 -6.05328594E-05 -6.18689951E-04 -2.51600617E-02
  7.22634081E-12 -4.71819881E-04 -4.82234313E-03 -1.96108650E-01 -2.97601091E-02
  4.13334135E-01  6.57867732E-01 -1.51929181E-02  1.17487566E-02 -6.52365708E-13
 -1.32153994E-12  7.37900726E-04  7.54188331E-03  3.06703300E-01 -7.87517933E-13
 -1.39965069E-12  7.33452638E-04  7.49642061E-03  3.04854483E-01  3.65529811E-04
 -5.06384389E-02 -3.32526879E-02  7.01577393E-03 -9.25160107E-05  8.32900137E-02
  4.24350527E-01 -2.13068800E-01  4.21844651E-03 -6.70804606E-02  1.90910344E-03
 -5.35983890E-03 -1.09315856E-01 -7.83215831E-02  6.13711972E-02  9.05104984E-02
 -7.12087437E-01 -2.44770632E-01  7.73216780E-03 -1.62303605E-01 -1.00162704E-01
 -1.14197183E-01  7.46220190E-01 -1.80749259E-02  2.92353932E-03 -6.69185529E-01
 -1.06630371E-01 -1.50227829E-01  3.95066954E-03  1.13998435E+00  3.21793137E-01
  5.60458160E-01 -1.45559615E-02 -8.88871411E-01  1.99105788E-03 -3.36013051E-02
  1.49836417E-01 -2.46342281E-01 -6.71141522E-01 -9.37520570E-02  9.23873042E-02
 -1.63608186E-01  3.80087593E-03 -6.76405666E-01 -6.24816079E-02 -1.94466992E-01
 -1.03800851E-01  3.02034977E-03  8.93996428E-04  2.25662953E-02 -3.00475190E-01
  1.93936584E-01 -4.04601523E-03 -4.77432913E-02  4.08205597E-01 -2.87631654E-01
  6.09080230E-03  2.87330240E-02 -1.03410629E-02  1.80877190E-02  7.20112826E-01
  3.54990818E-01  5.62341832E-01 -1.75032237E-01 -1.49655095E-01  3.78867215E-01
 -8.95634877E-03 -5.11274969E-01  1.86300029E-01 -4.00885897E-01 -2.73591019E-02
  1.63726034E-03 -4.83728320E-15 -1.16616395E-13 -4.12871787E-06 -4.21984986E-05
 -1.71607255E-03  2.64012620E-13 -1.83888546E-04 -1.87947501E-03 -7.64319951E-02
 -1.14472174E-02 -8.10912267E-01  3.47944129E-01 -1.05109424E-02 -1.91025581E-02
  2.07696707E-12 -8.00335828E-14 -1.33003582E-03 -1.35939357E-02 -5.52820132E-01
 -2.42693192E-12  4.58020051E-14  2.01600808E-03  2.06050722E-02  8.37939725E-01
 -9.83079189E-14 -4.20971285E-13 -6.00337417E-05 -6.13588603E-04 -2.49526069E-02
  1.97130435E-12 -9.65738596E-04 -9.87055243E-03 -4.01402525E-01  3.12593687E-02
 -2.46693496E-01 -7.09351415E-01  1.68603510E-02 -7.77500417E-03 -1.93532130E-12
 -1.09703778E-13  2.13056513E-03  2.17759287E-02  8.85554565E-01 -8.51787101E-13
 -1.87242809E-13  1.47480659E-03  1.50735984E-02  6.12993091E-01  1.08840332E-03
 -1.63673872E-01 -1.74013086E-02 -3.12232907E-02  8.09651717E-04  2.84632791E-01
  2.55250862E-01  4.02306352E-01 -1.05068884E-02 -8.91247636E-02 -2.13618131E-02
 -1.65442542E-02 -4.30340220E-01  8.95670196E-01 -9.63144269E-02 -6.87018685E-02
 -7.54848880E-01 -3.22984620E-01  9.75834251E-03 -9.27352064E-02 -6.89995730E-02
  3.04000850E-02 -8.08345457E-01  1.98042045E-02 -1.08198020E-01  1.55018125E-01
  3.29502170E-01  4.95448957E-01 -1.29759221E-02  1.88403766E+00  4.81463971E-01
  6.75714580E-01 -1.77742891E-02 -7.76044355E-01  1.02604958E-03 -2.90140484E-02
  1.46594642E-01 -1.87650436E-01 -9.42010039E-01 -4.26066909E-01 -4.08448525E-01
  9.21935228E-01 -2.16878444E-02 -1.01016187E+00 -4.57730842E-01  1.07340137E+00
  3.72953631E-02 -3.49960670E-03  3.68868721E-03 -2.01857169E-02  6.08113873E-01
 -4.19640563E-01  8.85596110E-03 -7.19660433E-02  1.08051959E+00 -7.19003182E-01
  1.50807699E-02  2.73912756E-02 -1.88977049E-02  3.24347560E-02  1.33370357E+00
  6.42732152E-01  1.25207669E+00  5.19116968E-01  3.21243384E-01 -1.05089516E+00
  2.50687975E-02 -1.16206687E+00 -4.87274264E-01  1.01232143E+00  1.55691815E-01
 -6.26404157E-03
Total SCF Density                          R   N=         300
  2.08289728E+00 -1.80036004E-01  5.01499492E-01  2.52221509E-02 -5.76695986E-02
  5.36057291E-01  3.98883769E-02 -9.09796135E-02  5.36991581E-02  5.89323747E-01
 -1.04154382E-03  2.37595119E-03 -6.47250261E-04  5.44177959E-03  8.15744505E-01
 -2.42405956E-01  5.18791277E-01 -1.40756605E-01 -2.25605385E-01  5.88632043E-03
  5.77959424E-01  2.06910321E-02 -5.30917873E-02  3.24896957E-01  7.10329327E-02
 -9.89786257E-04 -1.11477207E-01  1.99779052E-01  3.30923253E-02 -8.46484398E-02
  7.12331752E-02  3.92273373E-01  5.90814714E-03 -1.78481973E-01  6.90953465E-02
  2.64386709E-01 -8.63526360E-04  2.20925280E-03 -9.94710252E-04  5.90862891E-03
  6.39364638E-01  4.65710455E-03 -9.73719088E-04  5.65862067E-03  5.01127495E-01
 -1.70774936E-03  2.58703674E-03 -1.10694347E-02 -1.74785145E-02 -8.98629063E-04
  7.87297553E-03 -7.76100575E-03 -1.22264730E-02 -7.42812041E-04  6.90320390E-04
 -5.21167739E-05  1.39956923E-04 -6.46603181E-04  1.79179159E-04  1.88012113E-02
  2.92561281E-04 -3.98847251E-04  1.27929394E-04  1.47369751E-02 -1.10184017E-05
  4.34099041E-04 -1.02115503E-04  1.89798078E-04  4.10919850E-05 -6.61004068E-04
  2.99722887E-02  4.97215322E-04 -5.37724033E-05 -3.45639087E-04  2.34891027E-02
 -1.00085895E-05  6.90547214E-04  1.10254661E-03 -1.00352230E-03  2.69287077E-03
  2.02848107E-02 -2.55045134E-02 -1.13497136E-04  5.48486946E-03  1.04569722E-02
 -1.55025942E-02 -1.86242032E-04  3.51111794E-04 -3.19774411E-05  3.91604747E-05
  2.06766864E-03  1.92793993E-03 -5.51615338E-03  2.42747615E-02  1.10530412E-02
  2.04360278E-04 -1.10986805E-02  1.53236120E-02  8.98367423E-03  1.61225589E-04
 -7.39627958E-04 -2.22857283E-05 -2.29756474E-06  5.09117190E-04  1.23225056E-03
 -4.16932878E-02  8.69667346E-02 -1.04012931E-01  2.86233047E-01 -6.78827069E-03
  3.67389320E-02 -4.65556239E-02  1.76690962E-01 -4.23285042E-03 -6.39993217E-03
  3.40145424E-05 -7.06884343E-04 -1.77163500E-02 -7.36137904E-04  2.00466709E-01
  1.04495932E-02 -1.95345598E-02 -6.08321748E-02  1.54016393E-01 -3.64093104E-03
 -4.47655661E-02 -2.62424823E-02  9.76149696E-02 -2.33723070E-03 -3.22231464E-03
  1.96848687E-05 -3.78956049E-04 -9.85787008E-03 -3.82995449E-04  9.25247219E-02
  5.08541943E-02 -3.01788513E-03  4.83896290E-03  1.12860153E-02  1.62033964E-02
 -3.62954083E-04 -3.03629752E-04  7.62145713E-03  1.10857487E-02 -2.41835371E-04
 -6.71660049E-04 -1.80608207E-05 -3.46445034E-05 -2.69247689E-04  7.05632097E-04
  7.51963701E-03  2.80742853E-03  7.69305996E-04  1.16560107E-02 -2.07491644E-02
  1.35371147E-02 -1.94950862E-02  1.08707712E-03 -1.79808724E-02  7.40481912E-03
 -1.09923538E-02  7.54341658E-04  3.48474086E-04  3.34662684E-06  7.33212984E-05
  1.45638817E-03  3.80858458E-04 -1.87743994E-02 -7.13226500E-03 -6.39327802E-04
  2.13169031E-03 -2.79362409E-04  4.98583167E-04 -2.97389790E-04  1.08066229E-03
  2.60113416E-02  4.42883040E-04 -1.51320721E-04  7.45485671E-04  2.03907342E-02
 -5.01973357E-05  6.00058050E-04  9.54275028E-04 -5.72442676E-05  5.99641236E-06
  4.43573916E-04  1.68629117E-04  1.58694329E-05 -3.04477604E-05  8.31639667E-04
 -4.08978265E-02  8.54595263E-02  3.01686575E-01  2.83737176E-02 -1.42354520E-03
  3.69839571E-02  1.79686854E-01  3.38147241E-02 -1.26382000E-03 -6.41486079E-03
 -3.80360816E-04 -1.71182808E-05  1.17109729E-02  1.32349808E-02 -3.03574116E-02
 -3.54064060E-02  8.32600152E-03  2.21094003E-03 -7.43989853E-05  1.98543818E-01
  1.03449740E-02 -1.93903486E-02  1.67158252E-01  1.15623796E-02 -6.86488600E-04
 -4.41901976E-02  1.01025779E-01  1.88839639E-02 -7.07418711E-04 -3.30215318E-03
 -2.13984985E-04  2.75952974E-06  6.56596774E-03  7.49999905E-03 -3.56086776E-02
 -2.03732477E-02  3.34724713E-03  4.51010318E-03 -1.18957338E-04  9.35516117E-02
  5.21827766E-02  1.16567131E-02 -2.06094231E-02 -2.53149428E-02 -3.87545669E-03
  2.18290393E-04 -1.60249102E-02 -1.48249030E-02 -3.23851888E-03  1.63968501E-04
  6.07211540E-04  3.29349166E-05  7.74356217E-06 -9.36224684E-04 -1.08662182E-03
 -1.60481024E-03  2.64037833E-03 -9.73456571E-04  5.07438679E-04 -8.15456336E-06
 -2.00055467E-02 -7.77219858E-03  2.35545674E-03  2.23596568E-03 -4.46476035E-03
 -1.11110612E-03  1.70513538E-02  2.17950079E-04 -7.97292362E-03  5.11268476E-04
  1.12611543E-02  2.19252324E-04 -4.54072551E-04  9.62582223E-06 -1.75510938E-05
 -8.55023767E-04  2.10102676E-04  8.41771436E-03  4.84361277E-03  3.83664204E-04
 -5.43574186E-04  3.26947199E-05 -1.18948952E-03 -4.89056261E-04  1.15502806E-04
  5.15795913E-04 -8.30277645E-05  1.59373603E-04  1.50314570E-04  2.24600860E-04
  2.58000626E-02  2.34609972E-04  7.17606292E-05  2.28273977E-04  2.02216535E-02
 -3.31553570E-05  5.94451120E-04  9.47916833E-04  1.39450883E-06  1.43558114E-05
 -2.03131916E-04 -1.25457729E-04 -5.11092917E-06  3.23969295E-05  8.22764787E-04
  7.73812949E-05  3.07251862E-05 -6.54346321E-06  7.10994821E-06  8.16075595E-04
Mulliken Charges                           R   N=           3
 -6.80982819E-01  3.40141626E-01  3.40841193E-01
ONIOM Charges                              I   N=          16
           0           0           0           0           0           0
           0           0           0           0           0           0
           0           0           0           0
ONIOM Multiplicities                       I   N=          16
           1           0           0           0           0           0
           0           0           0           0           0           0
           0           0           0           0
Atom Layers                                I   N=           3
           1           1           1
Atom Modifiers                             I   N=           3
           0           0           0
Force Field                                I                0
Int Atom Modified Types                    I   N=           3
           0           0           0
Link Atoms                                 I   N=           3
           0           0           0
Atom Modified MM Charges                   R   N=           3
  0.00000000E+00  0.00000000E+00  0.00000000E+00
Link Distances                             R   N=          12
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00
Cartesian Gradient                         R   N=           9
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
Dipole Moment                              R   N=           3
  4.64108052E-01  7.30177906E-01 -1.90717942E-02
Quadrupole Moment                          R   N=           6
  3.43355128E-02  6.97954815E-01 -7.32290328E-01 -1.43446166E+00  3.94577753E-02
 -2.22383175E-02
QEq coupling tensors                       R   N=          18
 -1.27543734E+00  6.30144800E-01 -6.51857970E-01 -7.78625351E-03  6.19427153E-02
  1.92729531E+00  1.27593211E-01  2.28494131E-01 -4.11972589E-01 -5.24054303E-03
  1.65833876E-02  2.84379379E-01 -4.67844909E-01 -6.07445883E-02  1.95363018E-01
  3.27501915E-03  2.04394117E-03  2.72481891E-01
)";

TEST_CASE("Read Gaussian09 water fchk spherical basis", "[read]") {
    std::istringstream fchk(pure_fchk_contents);
    occ::io::FchkReader reader(fchk);
    REQUIRE(reader.num_alpha() == 5);
    REQUIRE(reader.num_basis_functions() == 24);
    REQUIRE(reader.basis().primitive_exponents[0] ==
            Catch::Approx(5.48467166e03));
    occ::io::FchkReader::FchkBasis basis = reader.basis();
    auto density = reader.scf_density_matrix();
    REQUIRE(density(0, 0) == Catch::Approx(2.08289728 * 0.5));
    auto obs = reader.basis_set();
}

void check_wavefunctions(const occ::qm::Wavefunction &wfn,
                         const occ::qm::Wavefunction &wfn2) {
    // fmt::print("Original D\n{}\n", wfn.mo.D);
    // fmt::print("After reading D\n{}\n", wfn2.mo.D);
    CHECK(wfn2.mo.D.rows() == wfn.mo.D.rows());
    CHECK(wfn2.mo.D.cols() == wfn.mo.D.cols());
    CHECK(all_close(wfn2.mo.D, wfn.mo.D, 1e-6, 1e-6));
    // fmt::print("Original C\n{}\n", wfn.mo.C);
    // fmt::print("After reading C\n{}\n", wfn2.mo.C);

    CHECK(wfn2.mo.C.rows() == wfn.mo.C.rows());
    CHECK(wfn2.mo.C.cols() == wfn.mo.C.cols());
    CHECK(all_close(wfn2.mo.C, wfn.mo.C, 1e-6, 1e-6));

    auto check_same_position = [](const occ::Vec3 &x1, const occ::Vec3 &x2) {
        for (size_t i = 0; i < 3; i++) {
            CHECK(x1(i) == Catch::Approx(x2(i)));
        }
    };

    auto check_same_coeffs = [](const auto &c1, const auto &c2) {
        for (size_t i = 0; i < c1.rows(); i++) {
            for (size_t j = 0; j < c1.cols(); j++) {
                CHECK(c1(i, j) == Catch::Approx(c2(i, j)));
            }
        }
    };

    for (size_t i = 0; i < wfn.basis.size(); i++) {
        const auto &sh1 = wfn.basis[i];
        const auto &sh2 = wfn2.basis[i];
        check_same_position(sh1.origin, sh2.origin);
        check_same_coeffs(sh1.exponents, sh2.exponents);
        check_same_coeffs(sh1.contraction_coefficients,
                          sh2.contraction_coefficients);
        CHECK(sh1.l == sh2.l);
        CHECK(sh1.kind == sh2.kind);
        CHECK(sh2.is_pure());
    }
}

TEST_CASE("Read/write pure spherical water 6-31G** fchk consistency",
          "[read,write]") {
    std::vector<occ::core::Atom> atoms{
        {8, -1.32695761, -0.10593856, 0.01878821},
        {1, -1.93166418, 1.60017351, -0.02171049},
        {1, 0.48664409, 0.07959806, 0.00986248}};

    auto obs = occ::qm::AOBasis::load(atoms, "6-31G**");
    obs.set_pure(true);
    HartreeFock hf(obs);
    occ::scf::SCF<HartreeFock> scf(hf);
    scf.convergence_settings.energy_threshold = 1e-8;
    double e = scf.compute_scf_energy();

    occ::qm::Wavefunction wfn = scf.wavefunction();

    std::string water_fchk_contents;
    {
        std::ostringstream fchk_os;
        occ::io::FchkWriter fchk_writer(fchk_os);
        fchk_writer.set_title("test water fchk");
        fchk_writer.set_method("hf");
        fchk_writer.set_basis_name("6-31G**");
        wfn.save(fchk_writer);
        fchk_writer.write();
        water_fchk_contents = fchk_os.str();
    }

    occ::qm::Wavefunction wfn2 = [&]() {
        std::istringstream fchk_is(water_fchk_contents);
        occ::io::FchkReader reader(fchk_is);
        return occ::qm::Wavefunction(reader);
    }();

    check_wavefunctions(wfn, wfn2);

    SECTION("Rotate by I") {
        occ::Mat rot = occ::Mat::Identity(3, 3);
        wfn2.apply_rotation(rot);
        fmt::print("orig MOs\n{}\n", wfn.mo.C);
        fmt::print("rot  MOs\n{}\n", wfn2.mo.C);
        check_wavefunctions(wfn, wfn2);
    }
}

// Gaussian Input

const char *g09_input_contents = R""""(%chk=h2o
#p HF/3-21G 6D 10f

this is a comment

0 1
O -0.0148150000  2.2222190000  0.0000000000
H  0.2124040000  2.7681990000 -0.7555250000
H  0.2124040000  2.7681990000  0.7555250000

)"""";

TEST_CASE("Read Gaussian input HF/3-21G water", "[read]") {
    std::istringstream inp(g09_input_contents);
    occ::io::GaussianInputFile reader(inp);
    REQUIRE(reader.charge == 0);
    REQUIRE(reader.method == "hf");
    REQUIRE(reader.basis_name == "3-21g");

    REQUIRE(reader.atomic_positions.size() == 3);
    REQUIRE(reader.elements.size() == 3);
    REQUIRE(reader.elements[2].atomic_number() == 1);
    REQUIRE(reader.spinorbital_kind() == occ::qm::SpinorbitalKind::Restricted);
}

// Molden

const char *molden_contents = R"([Molden Format]
[Atoms] AU
   O     1    8      2.6144618607    -1.1737415645     3.2306659313
   C     2    6      1.6655826985     0.9653027836     3.3528216670
   N     3    7      1.7538291687     2.6755151585     1.5464561943
   H     4    1      0.7377229620     1.5205669325     4.9122753972
   H     5    1      1.0998324509     4.1687453085     1.8193611186
   H     6    1      2.4850306817     2.3064779404     0.0779720255
[GTO]
    1  0
  s      3  0
       322.0370000000         3.2095934430
        48.4308000000         4.5991397399
        10.4206000000         2.9251827834
  s      2  0
         7.4029400000        -1.2936951550
         1.5762000000         1.2247121155
  p      2  0
         7.4029400000         4.2572304448
         1.5762000000         2.1497572264
  s      1  0
         0.3736840000         0.3406343727
  p      1  0
         0.3736840000         0.4164575278

    2  0
  s      3  0
       172.2560000000         2.0931324850
        25.9109000000         2.9367514349
         5.5333500000         1.8017371154
  s      2  0
         3.6649800000        -0.7473843397
         0.7705450000         0.7126610252
  p      2  0
         3.6649800000         1.7091775761
         0.7705450000         0.8856220644
  s      1  0
         0.1958570000         0.2098284709
  p      1  0
         0.1958570000         0.1857222602

    3  0
  s      3  0
       242.7660000000         2.6240920039
        36.4851000000         3.7343592057
         7.8144900000         2.3534541029
  s      2  0
         5.4252200000        -1.0471010485
         1.1491500000         0.9685500741
  p      2  0
         5.4252200000         2.8085856380
         1.1491500000         1.4567345480
  s      1  0
         0.2832050000         0.2766851047
  p      1  0
         0.2832050000         0.2944870717

    4  0
  s      2  0
         5.4471780000         0.3971513206
         0.8245470000         0.5579199233
  s      1  0
         0.1831920000         0.1995675705

    5  0
  s      2  0
         5.4471780000         0.3971513206
         0.8245470000         0.5579199233
  s      1  0
         0.1831920000         0.1995675705

    6  0
  s      2  0
         5.4471780000         0.3971513206
         0.8245470000         0.5579199233
  s      1  0
         0.1831920000         0.1995675705

[MO]
Sym= a
Ene=  -0.20412324348377E+02
Spin= Alpha
Occup=       2.0000000000
     1    0.983676995009
     2    0.099216133544
     3   -0.001782548338
     4    0.004232060210
     5   -0.000001020852
     6   -0.052945628333
     7    0.005593046704
     8   -0.013834535572
     9    0.000495493745
    10    0.000059795854
    11    0.000853871825
    12    0.000743901472
    13   -0.002144457014
    14    0.000333566935
    15    0.017456732382
    16    0.011007813058
    17   -0.018480595400
    18   -0.007527491269
    19    0.000136979912
    20    0.000687772133
    21    0.000466466115
    22   -0.000406591134
    23   -0.000691089916
    24   -0.002395128093
    25   -0.004976928128
    26    0.007067243531
    27    0.005093701883
    28    0.000374579627
    29    0.005793240246
    30   -0.002459487049
    31   -0.000833189987
    32    0.002764114958
    33    0.001463415413
Sym= a
Ene=  -0.15489083208433E+02
Spin= Alpha
Occup=       2.0000000000
     1    0.000075232233
     2    0.000508941628
     3    0.000181173065
     4    0.000040749838
     5   -0.000462116160
     6   -0.002223059181
     7   -0.000503982636
     8   -0.001933655262
     9    0.002996160028
    10   -0.000067463882
    11   -0.000922125257
    12    0.000048444686
    13    0.000443706831
    14   -0.000516387832
    15    0.021175768992
    16    0.001807051416
    17    0.008918161305
    18   -0.012476012338
    19    0.985676840922
    20    0.102137360431
    21   -0.000068178821
    22   -0.000648935776
    23    0.000846124726
    24   -0.065365784144
    25   -0.000038815976
    26    0.006836728627
    27   -0.006433888645
    28   -0.000728748512
    29    0.000975557137
    30   -0.000073719988
    31    0.008810264043
    32    0.000408004053
    33    0.008635486199
Sym= a
Ene=  -0.11286240340567E+02
Spin= Alpha
Occup=       2.0000000000
     1    0.000144181250
     2    0.001380438135
     3    0.000146781437
     4   -0.000199183111
     5   -0.000147554998
     6   -0.002825023831
     7    0.001653508048
     8   -0.004720181191
     9    0.000743702852
    10    0.986249041183
    11    0.093114624097
    12   -0.000099925609
    13   -0.000306029941
    14    0.000498611842
    15   -0.043331897760
    16    0.006648581114
    17   -0.008279662352
    18   -0.007201087634
    19    0.000113532836
    20    0.000098882714
    21    0.000269485465
    22    0.000656933623
    23   -0.001242120929
    24    0.003852842532
    25   -0.002315171881
    26    0.002090549318
    27    0.003498796578
    28   -0.002530377285
    29    0.019540112784
    30   -0.001464291308
    31    0.000883505029
    32    0.000505393798
    33    0.002848703604
Sym= a
Ene=  -0.13760191323062E+01
Spin= Alpha
Occup=       2.0000000000
     1   -0.182707687408
     2    0.169394220632
     3   -0.042298258480
     4    0.099677883851
     5    0.001633202616
     6    0.574729352626
     7   -0.045190173025
     8    0.113462062670
     9   -0.005279902929
    10   -0.136495199799
    11    0.157566528647
    12    0.051839266692
    13   -0.080770828145
    14   -0.040908222855
    15    0.136389584529
    16   -0.032213676307
    17    0.033238918860
    18    0.041321954220
    19   -0.094063396991
    20    0.084835705493
    21    0.001755398419
    22   -0.029780370588
    23    0.024771987239
    24    0.264550806711
    25    0.012898772782
    26   -0.048250024903
    27    0.015945559084
    28    0.041447602071
    29   -0.037361307641
    30    0.049868120192
    31   -0.000947193926
    32    0.041244958513
    33   -0.002367544542
Sym= a
Ene=  -0.12572346369903E+01
Spin= Alpha
Occup=       2.0000000000
     1    0.113999137624
     2   -0.109151929687
     3    0.022752177033
     4   -0.041689902751
     5   -0.012183159183
     6   -0.362363324092
     7    0.024869291988
     8   -0.044654914830
     9   -0.014101887410
    10   -0.019231694434
    11    0.025720221704
    12   -0.036265772526
    13    0.161292647278
    14   -0.069582010503
    15   -0.002785380871
    16   -0.003097826643
    17   -0.009448904308
    18    0.016022705763
    19   -0.197529198792
    20    0.183421352536
    21   -0.008421317708
    22    0.007868159770
    23    0.014321323688
    24    0.590237653146
    25   -0.010795563366
    26   -0.014062932665
    27    0.039729512856
    28    0.014406651643
    29    0.001023778237
    30    0.127876153487
    31    0.008415569347
    32    0.114267552796
    33    0.005777720571
Sym= a
Ene=  -0.88814002716217E+00
Spin= Alpha
Occup=       2.0000000000
     1    0.065210734803
     2   -0.066075121548
     3   -0.024735588572
     4    0.034090457626
     5    0.024230291152
     6   -0.226025635639
     7   -0.020147813093
     8    0.033525714016
     9    0.014171350376
    10   -0.140679162125
    11    0.172868624312
    12   -0.088551704941
    13    0.149350916981
    14    0.060256439588
    15    0.337390141817
    16   -0.069836001896
    17    0.089010163009
    18    0.074793698790
    19    0.048688971471
    20   -0.047703674990
    21   -0.064892990282
    22   -0.097973431616
    23    0.245103578736
    24   -0.166948364159
    25   -0.045666235209
    26   -0.080670932528
    27    0.184024666154
    28    0.183998083293
    29    0.039864429676
    30   -0.057282824804
    31   -0.024600883684
    32   -0.169896757343
    33   -0.058257528249
Sym= a
Ene=  -0.80299891584975E+00
Spin= Alpha
Occup=       2.0000000000
     1   -0.041845873740
     2    0.037174422083
     3   -0.004464816459
     4   -0.058295662443
     5    0.068840436033
     6    0.166407048494
     7   -0.006665304831
     8   -0.045920576648
     9    0.061925951585
    10    0.037958596054
    11   -0.054316349168
    12   -0.058705962909
    13   -0.032238286737
    14    0.172308585733
    15   -0.060147575031
    16   -0.024212566883
    17   -0.004702173671
    18    0.064719081550
    19   -0.004416170991
    20    0.005358386820
    21   -0.156179625550
    22    0.351998837368
    23    0.064447082509
    24   -0.002820462744
    25   -0.131297387334
    26    0.291932987000
    27    0.057777604470
    28    0.047874305613
    29    0.042464126937
    30    0.260880145964
    31    0.111827977651
    32   -0.119698144734
    33   -0.039933429470
Sym= a
Ene=  -0.70227661913728E+00
Spin= Alpha
Occup=       2.0000000000
     1    0.043483874895
     2   -0.040592115661
     3   -0.085103405735
     4    0.049719008229
     5    0.137741272751
     6   -0.172519794166
     7   -0.075559556920
     8    0.045888374286
     9    0.120124156523
    10   -0.039286852189
    11    0.046086495492
    12   -0.090179464145
    13   -0.105434012858
    14    0.288907984767
    15    0.180919050645
    16   -0.085474301136
    17    0.008737444831
    18    0.175014990728
    19    0.009650855953
    20   -0.008791610511
    21    0.094754876915
    22    0.027581542503
    23   -0.278281878346
    24   -0.054355511893
    25    0.091897567935
    26    0.023940006821
    27   -0.266405673323
    28    0.196633933858
    29    0.093033687928
    30   -0.049455098691
    31   -0.024627070747
    32    0.185602769750
    33    0.092671249667
Sym= a
Ene=  -0.58129089400250E+00
Spin= Alpha
Occup=       2.0000000000
     1    0.087798809238
     2   -0.080507754480
     3   -0.097030404604
     4    0.379218627105
     5   -0.002859812388
     6   -0.367217535175
     7   -0.102573977282
     8    0.394461572196
     9    0.000316088026
    10   -0.043465934599
    11    0.073646060052
    12    0.199558083789
    13   -0.249997164815
    14   -0.050455034005
    15    0.067604673276
    16    0.088431217840
    17   -0.020247568798
    18   -0.025823274478
    19    0.007330898736
    20   -0.006463376039
    21    0.023073286863
    22    0.122680935561
    23    0.043633164019
    24   -0.042103072609
    25    0.051513372323
    26    0.105004495560
    27    0.015355679494
    28   -0.091534445650
    29   -0.110543871593
    30    0.090786629245
    31    0.062388664114
    32   -0.059547568960
    33   -0.059650845740
Sym= a
Ene=  -0.56971204320704E+00
Spin= Alpha
Occup=       2.0000000000
     1   -0.019057831861
     2    0.017670256779
     3    0.226523572981
     4   -0.003826280631
     5    0.093521178431
     6    0.079229092527
     7    0.237978850040
     8   -0.004660173342
     9    0.096540450252
    10    0.008964032826
    11   -0.015790942120
    12    0.193318326146
    13    0.158885278888
    14    0.123379838748
    15   -0.010656479137
    16    0.210399766505
    17    0.101458842761
    18    0.113198649354
    19   -0.001121102386
    20    0.000876188384
    21    0.282368835369
    22    0.074343488736
    23    0.099114048907
    24    0.007986427654
    25    0.310392833727
    26    0.091499240480
    27    0.119727964869
    28    0.026663653101
    29    0.029531049005
    30   -0.025078716510
    31   -0.018131733830
    32    0.019375250464
    33    0.017674098125
Sym= a
Ene=  -0.41728810447477E+00
Spin= Alpha
Occup=       2.0000000000
     1   -0.001282572365
     2    0.003411513324
     3   -0.168451630943
     4   -0.075399060242
     5    0.447766802467
     6   -0.003668629031
     7   -0.191908747075
     8   -0.084472039649
     9    0.509079108397
    10    0.010135199539
    11   -0.002706299599
    12    0.046278025598
    13   -0.009755612828
    14   -0.093990467216
    15   -0.124576111621
    16   -0.024839395214
    17   -0.109957975416
    18    0.159617046740
    19   -0.038588154879
    20    0.013462356914
    21   -0.000679288219
    22   -0.096866965612
    23    0.094975222926
    24    0.344659784579
    25   -0.003923104597
    26   -0.160964381032
    27    0.162479784054
    28   -0.156195023459
    29   -0.259475274420
    30   -0.033936868618
    31   -0.018690396188
    32   -0.027040438284
    33   -0.050899123565
Sym= a
Ene=  -0.40004680785440E+00
Spin= Alpha
Occup=       2.0000000000
     1    0.000305352900
     2   -0.000000677682
     3   -0.298029999969
     4   -0.130142048780
     5   -0.132616378045
     6   -0.003608498432
     7   -0.364307096535
     8   -0.159795363917
     9   -0.163071388671
    10   -0.000325231550
    11    0.000132715124
    12   -0.081710825311
    13   -0.031467953029
    14   -0.033555691641
    15    0.002507814982
    16   -0.125114546679
    17   -0.055883606204
    18   -0.054666706670
    19    0.000617082944
    20   -0.000462150120
    21    0.301760177188
    22    0.112069290055
    23    0.121236282037
    24   -0.002976019754
    25    0.431561874919
    26    0.161847741726
    27    0.176511095692
    28    0.004330731941
    29    0.005287992758
    30    0.000581514618
    31    0.001180175541
    32    0.000337389097
    33    0.001592093547
Sym= a
Ene=   0.21072383652744E+00
Spin= Alpha
Occup=       0.0000000000
     1   -0.000642575000
     2    0.000021202257
     3   -0.251125553661
     4   -0.102057078180
     5   -0.112358321429
     6    0.007460921818
     7   -0.443240165730
     8   -0.179136095547
     9   -0.198100636117
    10   -0.000622257115
    11    0.000131436722
    12    0.343665023647
    13    0.144857110541
    14    0.154565891657
    15    0.009723330808
    16    0.639561693249
    17    0.280279563959
    18    0.294081772987
    19    0.000550784994
    20    0.000111647619
    21   -0.169783433728
    22   -0.062510754873
    23   -0.068012824286
    24   -0.008921326306
    25   -0.358224508286
    26   -0.126671087797
    27   -0.137110256067
    28   -0.002771094529
    29   -0.020832284905
    30   -0.006637618924
    31   -0.016585790011
    32    0.005644237533
    33    0.027384486548
Sym= a
Ene=   0.28965831290640E+00
Spin= Alpha
Occup=       0.0000000000
     1    0.005892010188
     2   -0.007092220593
     3   -0.025403194383
     4   -0.015965549783
     5    0.070962781525
     6   -0.033007609259
     7   -0.049500311065
     8   -0.021718937814
     9    0.125923708178
    10    0.038670735522
    11   -0.016656309941
    12    0.068767524117
    13   -0.019052229129
    14   -0.134118193344
    15   -0.795552670170
    16    0.236450012273
    17   -0.178047801384
    18   -0.345067044681
    19    0.105695737533
    20   -0.027496566966
    21    0.033310761997
    22   -0.136561790987
    23    0.036926931777
    24   -1.291977871381
    25    0.111265163764
    26   -0.537591853010
    27    0.189288727246
    28   -0.027974627947
    29    0.901575007666
    30    0.026848122280
    31    1.481491442210
    32    0.005087235436
    33    0.492475077460
Sym= a
Ene=   0.31899951270654E+00
Spin= Alpha
Occup=       0.0000000000
     1    0.000503298334
     2    0.010108670227
     3   -0.006143606279
     4    0.002519933200
     5   -0.002689210225
     6   -0.064460695224
     7   -0.029720817713
     8   -0.014161517825
     9    0.054769380790
    10    0.073829558815
    11   -0.027419871007
    12    0.091844524197
    13   -0.092446775843
    14   -0.103517511000
    15   -1.099086739129
    16    0.371915357127
    17   -0.323090226321
    18   -0.486723681060
    19   -0.087096903266
    20    0.027734961512
    21    0.061762688320
    22   -0.063985061422
    23   -0.104852364774
    24    1.044490394243
    25    0.232079334478
    26   -0.234577393791
    27   -0.396926319395
    28    0.028119081960
    29    1.465700839303
    30    0.025943430454
    31    0.143390329915
    32   -0.041562607593
    33   -1.455731684643
Sym= a
Ene=   0.38364746742476E+00
Spin= Alpha
Occup=       0.0000000000
     1    0.012201470736
     2   -0.012234128911
     3    0.043162018925
     4   -0.071090216365
     5   -0.034455160273
     6   -0.060623801803
     7    0.093401492529
     8   -0.117650526844
     9   -0.108941503469
    10   -0.093317190227
    11    0.039116032706
    12   -0.063835306382
    13    0.040683210327
    14    0.103138310382
    15    1.522956304831
    16   -0.367990352789
    17    0.338188924252
    18    0.533027217188
    19    0.025954391764
    20   -0.008945639966
    21    0.097482869849
    22   -0.093843094141
    23   -0.159516737773
    24   -0.317192324089
    25    0.472701027784
    26   -0.461827304589
    27   -0.746143640202
    28    0.021423401479
    29   -1.602313348350
    30    0.001926644426
    31    1.254298164005
    32   -0.020876186737
    33   -1.178090501047
Sym= a
Ene=   0.51146123541820E+00
Spin= Alpha
Occup=       0.0000000000
     1   -0.123989430424
     2    0.025385556833
     3   -0.083017046889
     4    0.165967125417
     5    0.033097433896
     6    1.589420389373
     7   -0.332161019854
     8    0.687766077638
     9    0.104946210694
    10    0.059987362044
    11    0.026522205991
    12   -0.046439240084
    13    0.093703206853
    14    0.006105016555
    15   -0.767323846821
    16   -0.696119661615
    17    1.784409052497
    18   -0.127487519541
    19    0.006130361329
    20    0.026242113156
    21    0.038345901738
    22   -0.035616585236
    23   -0.042406214164
    24   -0.433683034718
    25    0.162508644434
    26   -0.000440549063
    27   -0.342114599333
    28    0.013988513403
    29   -0.206812184976
    30   -0.126586207022
    31    0.016250385879
    32    0.137655964810
    33   -0.249743571010
Sym= a
Ene=   0.60911599467455E+00
Spin= Alpha
Occup=       0.0000000000
     1    0.030742880462
     2   -0.024237586447
     3   -0.019982701661
     4   -0.112593603763
     5    0.149025067123
     6   -0.224675206695
     7   -0.048374271469
     8   -0.315316650338
     9    0.405076992079
    10   -0.103916715414
    11   -0.027870179495
    12    0.097532413469
    13    0.086625406702
    14   -0.294078483981
    15    1.824405774623
    16    0.384960591375
    17    0.933741293260
    18   -1.745290612846
    19    0.097659901772
    20   -0.033790054191
    21   -0.004128126170
    22    0.214559511083
    23   -0.188336869213
    24   -1.396739658759
    25   -0.047017600463
    26    1.210069107615
    27   -1.019441735892
    28   -0.077166564210
    29    0.655221570846
    30   -0.029160244238
    31   -0.674328541344
    32   -0.082663761587
    33   -0.342502405605
Sym= a
Ene=   0.95602720344067E+00
Spin= Alpha
Occup=       0.0000000000
     1   -0.000122293743
     2    0.000326702556
     3    0.027915736489
     4    0.011911153805
     5    0.012844826290
     6    0.000404025859
     7    0.127020714918
     8    0.053498343406
     9    0.058076645465
    10    0.000420138337
    11    0.000099602331
    12    0.912375926153
    13    0.380147459901
    14    0.413561455066
    15   -0.004787344701
    16   -0.945685469486
    17   -0.396562569570
    18   -0.431113439250
    19   -0.000184981638
    20    0.000027409863
    21    0.082922503160
    22    0.026009581482
    23    0.031484429549
    24   -0.002563927065
    25    0.119830564327
    26    0.046335554303
    27    0.052967831989
    28    0.004185668081
    29    0.000668764769
    30    0.002171189779
    31    0.012179165370
    32   -0.002185315534
    33   -0.008941647847
Sym= a
Ene=   0.99563593659817E+00
Spin= Alpha
Occup=       0.0000000000
     1   -0.008950286698
     2    0.011659231264
     3    0.032414757425
     4    0.072433724556
     5   -0.137024507842
     6   -0.009602297274
     7    0.052097108019
     8    0.117798406921
     9   -0.221783519140
    10   -0.033799890088
    11    0.123152190965
    12    0.155081961024
    13    0.483804543491
    14   -0.786519373554
    15    0.306016616133
    16   -0.511762246848
    17   -0.381948855492
    18    1.471462270009
    19    0.027543400414
    20   -0.049175231462
    21    0.019900547081
    22    0.002442483406
    23   -0.036569343838
    24    0.448515482585
    25   -0.041723821329
    26    0.209655909614
    27   -0.062894008846
    28   -0.426124238008
    29   -0.533907002420
    30   -0.266126867611
    31    0.089619805425
    32    0.157701173138
    33    0.073865132512
Sym= a
Ene=   0.10498987525831E+01
Spin= Alpha
Occup=       0.0000000000
     1   -0.045072029277
     2    0.067818863963
     3   -0.127600513621
     4    0.184370339433
     5    0.110401646935
     6   -0.005472104930
     7   -0.169492978012
     8    0.313624348463
     9    0.082499685174
    10    0.050936500804
    11    0.146183592434
    12   -0.336902174881
    13    0.893131925700
    14   -0.081492587579
    15   -0.813047529746
    16    0.494956943135
    17   -0.704326274656
    18   -0.434344196213
    19    0.018069974732
    20   -0.003488959987
    21   -0.009970136872
    22    0.002960366623
    23   -0.002468774722
    24    0.086890345830
    25    0.078709696202
    26   -0.009640597777
    27   -0.203077667757
    28    0.601835621217
    29    0.256603134337
    30    0.216768662069
    31    0.112613913675
    32   -0.214041512999
    33   -0.075732111653
Sym= a
Ene=   0.11696227552925E+01
Spin= Alpha
Occup=       0.0000000000
     1   -0.002189440427
     2    0.005526076135
     3   -0.059277060025
     4    0.193138219165
     5   -0.045067784285
     6   -0.356296778266
     7   -0.053413486792
     8    0.023156528975
     9    0.101605961109
    10    0.021906098834
    11   -0.650861049966
    12   -0.404910419020
    13    0.385285883379
    14    0.543779955021
    15    0.613730624289
    16    0.506956669207
    17   -0.399382580528
    18   -0.783549338410
    19   -0.032131872215
    20   -0.019714047225
    21    0.055227903678
    22   -0.050518967557
    23   -0.081359829355
    24    0.071580331966
    25   -0.239052822819
    26    0.576593599500
    27    0.051036948012
    28   -0.706516143577
    29    0.872300789927
    30   -0.581429218178
    31   -0.027809207407
    32   -0.091140049385
    33   -0.115291618544
Sym= a
Ene=   0.12135736520070E+01
Spin= Alpha
Occup=       0.0000000000
     1    0.002366428391
     2   -0.022655358154
     3   -0.009064754416
     4    0.010668470130
     5    0.012945222724
     6   -0.067808311983
     7   -0.033019851217
     8    0.050023555151
     9    0.026210353821
    10   -0.042795981542
    11   -0.049124005404
    12   -0.158527046402
    13    0.212463272717
    14    0.158349077302
    15   -0.326884379097
    16    0.204453275059
    17   -0.267408829920
    18   -0.212664248731
    19    0.082247002494
    20   -0.004635053613
    21    0.027721571655
    22    0.198044703240
    23   -0.252071544135
    24   -0.625862283717
    25   -0.128808294269
    26   -0.530132784250
    27    0.792803829908
    28   -0.330351961121
    29    0.457909522686
    30    0.746981595734
    31   -0.057735333838
    32    0.980558062968
    33   -0.150430313157
Sym= a
Ene=   0.13918918936993E+01
Spin= Alpha
Occup=       0.0000000000
     1   -0.000131516829
     2    0.001034158799
     3   -0.055201252061
     4   -0.019821986661
     5   -0.026298654472
     6   -0.005445567077
     7   -0.033178287389
     8   -0.015001638933
     9   -0.012929123600
    10    0.000249505004
    11   -0.001582235881
    12   -0.077271650319
    13   -0.026751150932
    14   -0.031692167132
    15    0.003673515149
    16    0.351832159101
    17    0.136016546273
    18    0.147566418480
    19    0.000403946292
    20   -0.000056817783
    21    0.931126771262
    22    0.343569022892
    23    0.374801660758
    24   -0.004483072516
    25   -0.967502162319
    26   -0.380120232245
    27   -0.410059000001
    28    0.000607280378
    29    0.001527566990
    30    0.021822584240
    31   -0.000351577197
    32   -0.017676969980
    33    0.002308268734
Sym= a
Ene=   0.15710829307557E+01
Spin= Alpha
Occup=       0.0000000000
     1    0.006476383414
     2   -0.006519455789
     3   -0.096611502810
     4    0.198336783780
     5    0.034466481218
     6   -0.277326814580
     7    0.114893088124
     8   -0.194039708376
     9   -0.077869174196
    10    0.052506411621
    11   -1.504810441443
    12    0.223772780476
    13   -0.131556583293
    14   -0.378100195709
    15    2.463875019174
    16   -0.376501669664
    17    0.215520570600
    18    0.637394450441
    19    0.009326309615
    20   -0.002455801114
    21    0.019460861333
    22    0.043270891963
    23   -0.086952714535
    24   -0.370761087203
    25   -0.032153937893
    26   -0.039058820469
    27    0.122068778422
    28    0.535132031202
    29   -1.597258312626
    30    0.064886723064
    31   -0.023381639378
    32    0.188542438581
    33   -0.001898257710
Sym= a
Ene=   0.16044607937080E+01
Spin= Alpha
Occup=       0.0000000000
     1   -0.016946599227
     2    0.045935554844
     3    0.023141868644
     4    0.018556274615
     5   -0.075387400052
     6    0.192336487275
     7   -0.025991940101
     8    0.075745055865
     9   -0.009265734513
    10   -0.008018200877
    11   -0.065452437793
    12    0.033811929863
    13   -0.027426242420
    14   -0.056724769011
    15   -0.006092790789
    16   -0.303722659435
    17    0.259181924537
    18    0.445963336240
    19   -0.003768190300
    20    0.009375036739
    21    0.442601691199
    22   -0.498523083577
    23   -0.673480934924
    24    0.012152450512
    25   -0.206062267878
    26    0.107455121349
    27    0.463324839762
    28   -0.210470515932
    29   -0.223350664070
    30    0.698095010683
    31   -0.754915043259
    32   -0.748932960264
    33    0.967181050509
Sym= a
Ene=   0.16394023547005E+01
Spin= Alpha
Occup=       0.0000000000
     1    0.007143655921
     2    0.017435235524
     3   -0.042782471511
     4    0.107639539410
     5   -0.017248878200
     6   -0.182999172425
     7    0.037216791219
     8   -0.226524655730
     9    0.139130577495
    10    0.012116509135
    11   -0.148285193280
    12   -0.024923869276
    13   -0.013687553154
    14    0.065470992948
    15    1.543640820262
    16    0.185717714228
    17    0.554295225485
    18   -0.941362685585
    19    0.057638601251
    20   -0.129223854740
    21    0.035646222217
    22   -0.838269192429
    23    0.673710875565
    24   -0.517255813795
    25   -0.041159776692
    26    1.429448670123
    27   -1.212466306602
    28   -0.146107279540
    29    0.297186984874
    30    0.438905865169
    31   -0.917390211137
    32    0.328889613235
    33   -0.629452684536
Sym= a
Ene=   0.18037508290481E+01
Spin= Alpha
Occup=       0.0000000000
     1    0.069854561277
     2   -0.205517156481
     3   -0.182990668793
     4    0.298749715832
     5    0.206301245737
     6   -0.633906084058
     7    0.269500859939
     8   -0.632513992682
     9   -0.072650622484
    10    0.017481865581
    11    0.528450831927
    12    0.034439695271
    13   -0.120097769883
    14    0.022535631653
    15   -0.762477764929
    16    0.908245058534
    17   -1.190690665832
    18   -0.947419139080
    19   -0.010814151131
    20    0.058741616109
    21    0.299757693414
    22   -0.353847722088
    23   -0.378247241456
    24    0.152493141355
    25   -1.121857587452
    26    1.374577377956
    27    1.431635281446
    28    0.475480586345
    29    0.804198837493
    30   -0.726801974756
    31   -0.452564734060
    32    0.644901638807
    33    0.541951115267
Sym= a
Ene=   0.19293179635654E+01
Spin= Alpha
Occup=       0.0000000000
     1   -0.002416828675
     2    0.009214956398
     3    0.903718589136
     4    0.351047073222
     5    0.390546108498
     6    0.012696839136
     7   -0.947221890883
     8   -0.357819910980
     9   -0.408486537782
    10   -0.000710088279
    11   -0.017848545489
    12   -0.026956788208
    13   -0.004707745723
    14   -0.010998304643
    15    0.022263509768
    16    0.313219369617
    17    0.168402665599
    18    0.155165221635
    19    0.000390954915
    20   -0.001236567316
    21    0.053171962738
    22    0.022190780280
    23    0.034457448552
    24   -0.006307515509
    25   -0.130213043052
    26   -0.078051337491
    27   -0.105127074220
    28   -0.007715307468
    29   -0.013434157280
    30    0.020689278067
    31   -0.000732784528
    32   -0.015167391248
    33   -0.015754197477
Sym= a
Ene=   0.20066700622545E+01
Spin= Alpha
Occup=       0.0000000000
     1   -0.029135489378
     2    0.132426823303
     3    0.158348265025
     4   -0.861946232185
     5    0.413869746994
     6   -0.098140103417
     7   -0.199723386795
     8    1.016470123010
     9   -0.457404625128
    10   -0.013382275908
    11   -0.309555594610
    12   -0.042294618224
    13    0.129811538624
    14   -0.029939638170
    15   -0.186616450397
    16    0.071274229458
    17   -0.332597751322
    18    0.118096297024
    19   -0.010036663826
    20    0.001417153560
    21    0.123209036077
    22   -0.232528942753
    23   -0.075324573816
    24    0.278463220935
    25   -0.401687194638
    26    0.546684055200
    27    0.476044936797
    28    0.121433622143
    29   -0.047881132772
    30   -0.251613691877
    31   -0.245967014011
    32    0.243301500161
    33    0.180370201326
Sym= a
Ene=   0.20572201193012E+01
Spin= Alpha
Occup=       0.0000000000
     1   -0.000875686347
     2   -0.003321323299
     3   -0.436645608815
     4    0.194734964131
     5    0.821413594277
     6    0.182618847990
     7    0.548700341617
     8   -0.156529228960
     9   -1.116338593043
    10   -0.000510247129
    11    0.038040918823
    12    0.053943820474
    13   -0.055474612448
    14   -0.064935080204
    15    0.415938810793
    16   -0.697033739065
    17    0.235622567065
    18    1.373498027862
    19   -0.016883930785
    20    0.176560019610
    21   -0.090100191978
    22    0.125847882888
    23    0.099326507184
    24    0.118711852959
    25    0.490791751856
    26   -0.816076518663
    27   -0.428692233560
    28   -0.455927722648
    29   -0.732451783025
    30    0.294350746794
    31    0.351336235525
    32   -0.318998626842
    33   -0.060593324608
Sym= a
Ene=   0.27416250151010E+01
Spin= Alpha
Occup=       0.0000000000
     1   -0.008835030191
     2    0.069809611063
     3   -0.062892480848
     4    0.020346593969
     5    0.126084696773
     6   -0.004997434665
     7    0.118770389890
     8    0.067016600683
     9   -0.335458689759
    10    0.019928654109
    11    0.104803753621
    12    0.008234922299
    13   -0.109933983562
    14    0.084047920291
    15   -1.448156351694
    16   -0.129063515597
    17   -0.689865862941
    18    0.941152475555
    19   -0.001258310391
    20   -1.901000647497
    21    0.004884199910
    22    0.105185821545
    23   -0.109539243229
    24    3.596685473013
    25   -0.007941719721
    26   -0.568855149353
    27    0.556299198031
    28    0.046872399073
    29   -0.100118315704
    30   -0.145893074045
    31   -0.355954541952
    32   -0.158190117879
    33   -0.359864972343
Sym= a
Ene=   0.35550722686002E+01
Spin= Alpha
Occup=       0.0000000000
     1    0.050305680242
     2   -1.748814460455
     3    0.089149259443
     4   -0.226964438096
     5    0.016093987415
     6    2.876011331628
     7   -0.371787407595
     8    0.962888084828
     9   -0.077552103078
    10    0.011028090862
    11   -0.140824139319
    12   -0.080039098782
    13    0.220721872526
    14   -0.025772781673
    15   -1.038297781639
    16   -0.768231511040
    17    1.162594227835
    18    0.650978074823
    19   -0.008418642649
    20   -0.135065573880
    21   -0.047165215853
    22    0.040985050784
    23    0.070194436391
    24    0.336289539677
    25    0.425934577703
    26   -0.602091240059
    27   -0.448661620140
    28   -0.072517219122
    29   -0.452282346762
    30    0.246375795817
    31    0.065660179175
    32   -0.287574738111
    33   -0.140885037876
)";

TEST_CASE("Read molden output formamide molecule", "[read]") {
    std::istringstream molden(molden_contents);
    occ::io::MoldenReader reader(molden);
    for (const auto &atom : reader.atoms()) {
        fmt::print("{} {} {} {}\n", atom.atomic_number, atom.x, atom.y, atom.z);
    }
}

// Orca JSON

using occ::Mat;

const char *json_contents = R"(
{
    "Molecule": {
        "Atoms": [
            {
                "BasisFunctions": [
                    {
                        "Coefficients": [
                            0.1543289707029839,
                            0.5353281424384732,
                            0.44463454202535485
                        ],
                        "Exponents": [
                            3.42525091,
                            0.62391373,
                            0.1688554
                        ],
                        "Shell": "s"
                    }
                ],
                "Coords": [
                    0.0,
                    0.0,
                    0.0
                ],
                "ElementLabel": "H",
                "ElementNumber": 1,
                "Idx": 0,
                "NuclearCharge": 1.0
            },
            {
                "BasisFunctions": [
                    {
                        "Coefficients": [
                            0.1543289707029839,
                            0.5353281424384732,
                            0.44463454202535485
                        ],
                        "Exponents": [
                            3.42525091,
                            0.62391373,
                            0.1688554
                        ],
                        "Shell": "s"
                    }
                ],
                "Coords": [
                    0.0,
                    0.0,
                    2.6456165874897524
                ],
                "ElementLabel": "H",
                "ElementNumber": 1,
                "Idx": 1,
                "NuclearCharge": 1.0
            }
        ],
        "BaseName": "h2",
        "Charge": 0,
        "CoordinateUnits": "Bohrs",
        "H-Matrix": [
            [
                -0.8422289108173067,
                -0.3785030189433606
            ],
            [
                -0.3785030189433606,
                -0.8422289108173067
            ]
        ],
        "HFTyp": "RHF",
        "MolecularOrbitals": {
            "EnergyUnit": "Eh",
            "MOs": [
                {
                    "MOCoefficients": [
                        0.621202118970972,
                        0.621202118970972
                    ],
                    "Occupancy": 2.0,
                    "OrbitalEnergy": -0.3773228237944341
                },
                {
                    "MOCoefficients": [
                        -0.8425697665943784,
                        0.8425697665943784
                    ],
                    "Occupancy": 0.0,
                    "OrbitalEnergy": 0.25890197203084375
                }
            ],
            "OrbitalLabels": [
                "0H   1s",
                "1H   1s"
            ]
        },
        "Multiplicity": 1,
        "S-Matrix": [
            [
                1.0,
                0.29569907102006404
            ],
            [
                0.29569907102006404,
                1.0
            ]
        ],
        "T-Matrix": [
            [
                0.7600318835666087,
                0.019745102188373418
            ],
            [
                0.019745102188373418,
                0.7600318835666087
            ]
        ]
    },
    "ORCA Header": {
        "Version": "5.0 - current"
    }
}
)";

TEST_CASE("Read orca output JSON H2", "[read]") {

    std::istringstream json_istream(json_contents);
    occ::io::OrcaJSONReader reader(json_istream);
    fmt::print("Atomic numbers:\n{}\n", reader.atomic_numbers());
    fmt::print("Atomic positions:\n{}\n", reader.atom_positions());
    std::vector<occ::core::Atom> atoms = reader.atoms();
    Mat S1 = reader.overlap_matrix();
    fmt::print("ORCA Overlap matrix:\n{}\n", S1);

    HartreeFock hf(reader.basis_set());
    Mat S2 = hf.compute_overlap_matrix();
    fmt::print("OUR Overlap matrix:\n{}\n", S2);
    fmt::print("Difference\n{}\n", S2 - S1);
    REQUIRE(occ::util::all_close(S1, S2));
}

// QCSchema

const char *json_input_contents = R""""({
    "schema_name": "qcschema_input",
    "schema_version": 1,
    "return_output": true,
    "molecule": {
        "geometry": [
            0.0,
            0.0,
            -0.1294769411935893,
            0.0,
            -1.494187339479985,
            1.0274465079245698,
            0.0,
            1.494187339479985,
            1.0274465079245698
        ],
        "symbols": [
            "O",
            "H",
            "H"
        ]
    },
    "driver": "energy",
    "model": {
        "method": "b3lyp",
        "basis": "6-31g"
    },
    "keywords": {
        "scf_type": "df",
        "mp2_type": "df",
        "cc_type": "df",
        "scf_properties": ["mayer_indices"]
    }
}
)"""";

TEST_CASE("Read QCSchema formatted input water b3lyp/6-31G", "[read]") {
    std::istringstream json(json_input_contents);
    occ::io::QCSchemaReader reader(json);
}

TEST_CASE("Serial Molecule & Dimer to JSON", "[json,write]") {
    fmt::print("Molecule to JSON\n");
    auto acetic = acetic_crystal();
    auto dimers = acetic.unit_cell_dimers(3.8);
    const auto &mols = acetic.symmetry_unique_molecules();
    nlohmann::json j;
    j["symmetry_unique_molecules"] = mols;
    fmt::print("{}\n", j.dump());
    fmt::print("Dimer to JSON\n");
    nlohmann::json jd;
    jd["symmetry_unique_dimers"] = dimers.unique_dimers;
    fmt::print("{}\n", jd.dump());
}

const char *gmf_file_contents = R""""(
 title: Created by occ
  name: acetic
 space: P n a 21
  cell: 13.310000 4.100000 5.750000  90.000000 90.000000 90.000000
 morph: unrelaxed equilibrium

miller:    1   1   0
 0.000000   1  1      0.0000     0.0000     0.0000     0.0000  -1
)"""";

TEST_CASE("GMFWriter Tests", "[GMFWriter]") {
    using occ::io::GMFWriter;

    GMFWriter::Facet facet = {{1, 1, 0}, 0.0, 1, 1, 0.0, 0.0, 0.0, 0.0, -1};
    auto crystal = acetic_crystal();

    SECTION("Setting properties") {
        GMFWriter gmf(crystal);

        gmf.set_title("Created by occ");
        REQUIRE(gmf.title() == "Created by occ");
        gmf.set_name("acetic");
        REQUIRE(gmf.name() == "acetic");

        gmf.set_morphology_kind("unrelaxed equilibrium");
        REQUIRE(gmf.morphology_kind() == "unrelaxed equilibrium");

        gmf.add_facet(facet);
        REQUIRE(gmf.number_of_facets() == 1);
    }

    SECTION("Checking file content") {
        GMFWriter gmf(crystal);
        gmf.set_title("Created by occ");
        gmf.set_name("acetic");
        gmf.set_morphology_kind("unrelaxed equilibrium");
        gmf.add_facet(facet);

        std::ostringstream gmf_os;
        gmf.write(gmf_os);
        std::string contents = gmf_os.str();
        REQUIRE(gmf_os.str() == gmf_file_contents);
    }
}

TEST_CASE("Read/Write Wavefunction JSON", "[JSON]") {
    using occ::io::JsonWavefunctionReader;
    using occ::io::JsonWavefunctionWriter;
    std::vector<occ::core::Atom> atoms{
        {8, -1.32695761, -0.10593856, 0.01878821},
        {1, -1.93166418, 1.60017351, -0.02171049},
        {1, 0.48664409, 0.07959806, 0.00986248}};

    auto obs = occ::qm::AOBasis::load(atoms, "6-31G**");
    obs.set_pure(true);
    HartreeFock hf(obs);
    occ::scf::SCF<HartreeFock> scf(hf);
    scf.convergence_settings.energy_threshold = 1e-8;
    double e = scf.compute_scf_energy();

    occ::qm::Wavefunction wfn = scf.wavefunction();

    JsonWavefunctionWriter writer;

    std::string json_contents = writer.to_string(wfn);
    std::istringstream json_stream(json_contents);

    JsonWavefunctionReader reader(json_stream);

    auto wfn2 = reader.wavefunction();

    REQUIRE(wfn.basis == wfn2.basis);
    REQUIRE(wfn.atoms.size() == wfn2.atoms.size());
}

TEST_CASE("Read/Write Wavefunction JSON with ECP", "[JSON]") {
    using occ::io::JsonWavefunctionReader;
    using occ::io::JsonWavefunctionWriter;
    std::vector<occ::core::Atom> atoms{{86, 0.0, 0.0, 0.0}};

    auto obs = occ::qm::AOBasis::load(atoms, "def2-svp");
    obs.set_pure(true);
    HartreeFock hf(obs);
    occ::scf::SCF<HartreeFock> scf(hf);
    scf.convergence_settings.energy_threshold = 1e-8;
    double e = scf.compute_scf_energy();

    occ::qm::Wavefunction wfn = scf.wavefunction();

    JsonWavefunctionWriter writer;

    std::string json_contents = writer.to_string(wfn);
    std::istringstream json_stream(json_contents);

    JsonWavefunctionReader reader(json_stream);

    auto wfn2 = reader.wavefunction();

    REQUIRE(wfn.basis == wfn2.basis);
    REQUIRE(wfn.atoms.size() == wfn2.atoms.size());
}

TEST_CASE("read/write dftb gen format", "[write,read]") {
    auto acetic = acetic_crystal();
    SECTION("Crystal") {
	std::string gen_contents;

	{
	    occ::io::DftbGenFormat gen;
	    gen.set_crystal(acetic);
	    std::ostringstream gen_contents_stream;
	    gen.write(gen_contents_stream);
	    gen_contents = gen_contents_stream.str();
	}
	fmt::print("dftb gen contents (crystal):\n{}\n", gen_contents);

	{
	    std::istringstream gen_contents_stream(gen_contents);
	    occ::io::DftbGenFormat gen;
	    gen.parse(gen_contents_stream);
	    auto maybe_crystal = gen.crystal();
	    REQUIRE(maybe_crystal);
	    auto acetic_read = maybe_crystal.value();
	    REQUIRE(all_close(acetic_read.unit_cell().direct(), acetic.unit_cell().direct()));
	    REQUIRE(acetic_read.asymmetric_unit().size() == 4 * acetic.asymmetric_unit().size());
	}
    }
    SECTION("Molecule") {
	std::string gen_contents;
	auto mol = acetic.symmetry_unique_molecules()[0];
	{
	    occ::io::DftbGenFormat gen;
	    gen.set_molecule(mol);
	    std::ostringstream gen_contents_stream;
	    gen.write(gen_contents_stream);
	    gen_contents = gen_contents_stream.str();
	}
	fmt::print("dftb gen contents (molecule):\n{}\n", gen_contents);

	{
	    std::istringstream gen_contents_stream(gen_contents);
	    occ::io::DftbGenFormat gen;
	    gen.parse(gen_contents_stream);
	    auto maybe_molecule = gen.molecule();
	    REQUIRE(maybe_molecule);
	    auto acetic_read = maybe_molecule.value();
	    REQUIRE(all_close(acetic_read.positions(), mol.positions()));
	    REQUIRE(acetic_read.atomic_numbers() == mol.atomic_numbers());
	}
    }
}
